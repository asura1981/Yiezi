<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-gb" lang="en-gb" >
<head>
<!--[if gte IE 8.0]>
<style type="text/css">
.clearfix {display: block;}
/>
</style>
<![endif]-->
<link rel="shortcut icon" href="http://yiezi.parseapp.com/icon/Yiezi.ico" >
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!--base href="http://www.yiezi.com/index.php/yiezi" /-->
<base href="http://yiezi.parseapp.com/" />

<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="author" content="Super User" />
<meta name="generator" content="Joomla! - Open Source Content Management" />
<title>Yiezi</title>
<!--link rel="stylesheet" href="/libraries/gantry/css/grid-responsive.css" type="text/css" /-->
<link rel="stylesheet" href="/grid-responsive.css" type="text/css" />
<!--link rel="stylesheet" href="/templates/rt_diametric_responsive/css/gantry-core.css" type="text/css" /-->
<link rel="stylesheet" href="/gantry-core.css" type="text/css" />
<!--link rel="stylesheet" href="/templates/rt_diametric_responsive/css/joomla-core.css" type="text/css" /-->
<link rel="stylesheet" href="/joomla-core.css" type="text/css" />
<!--link rel="stylesheet" href="/templates/rt_diametric_responsive/css/overlays.css" type="text/css" /-->
<link rel="stylesheet" href="/overlays.css" type="text/css" />
<!--link rel="stylesheet" href="/templates/rt_diametric_responsive/css/body-light.css" type="text/css" /-->
<link rel="stylesheet" href="/body-light.css" type="text/css" />
<!--link rel="stylesheet" href="/templates/rt_diametric_responsive/css/menu-dark.css" type="text/css" /-->
<link rel="stylesheet" href="/menu-dark.css" type="text/css" />
<!--link rel="stylesheet" href="/templates/rt_diametric_responsive/css/responsive.css" type="text/css" /-->
<link rel="stylesheet" href="/responsive.css" type="text/css" />
<!--link rel="stylesheet" href="/templates/rt_diametric_responsive/css/demo-styles.css" type="text/css" /-->
<link rel="stylesheet" href="/demo-styles.css" type="text/css" />
<!--link rel="stylesheet" href="/templates/rt_diametric_responsive/css/splitmenu.css" type="text/css" /-->
<link rel="stylesheet" href="/splitmenu.css" type="text/css" />
<!--link rel="stylesheet" href="/templates/rt_diametric_responsive/css/template.css" type="text/css" /-->
<link rel="stylesheet" href="/template.css" type="text/css" />
<!--link rel="stylesheet" href="/template-webkit.css" type="text/css" /-->
<!--link rel="stylesheet" href="/templates/rt_diametric_responsive/css/template-webkit.css" type="text/css" /-->
<link rel="stylesheet" href="/template-webkit.css" type="text/css" />
<style type="text/css">
#rt-main-container article h2 span, #rt-main-container a, #rt-main-container h1 span, #rt-main-container .module-title .title span,#rt-body-surround .sprocket-lists .sprocket-lists-container li.active .sprocket-lists-title, body #roksearch_results h3, body #roksearch_results a, .item-title, .component-body .thumbnail a {color:#A3CD65;}
#rt-navigation, #rt-navigation .rt-menubar ul.menutop li.active {background-color:#8cc13f;}
#rt-main-container .readon span, #rt-main-container .readon .button, #rt-main-container .button, #rt-main-container .btn, .component-content .formelm-buttons button, .component-body #imageForm.form-horizontal button, .component-body #uploadform button {background-color:#8cc13f;}
#rt-body-surround .box1 .module-surround, #rt-body-surround .box4 .module-surround, .rg-grid-view .tag, .rg-list-view .tag, .rg-detail-slicetag .tag, .rg-detail-filetag .tag  {background-color:#A3CD65;}
.menutop .rt-arrow-pointer {border-top-color:#89bd3d;}
#rt-main-container.body-overlay-light a:hover, #rt-main-container.body-overlay-light .title a:hover span {color:#7ead38;}
#rt-main-container.body-overlay-dark a:hover, #rt-main-container.body-overlay-dark .title a:hover span {color:#c6e09f;}
#rt-body-surround.body-accentoverlay-dark .box1 a, #rt-body-surround.body-accentoverlay-dark .box1 .title span, #rt-body-surround.body-accentoverlay-dark .box4 a, #rt-body-surround.body-accentoverlay-dark .box4 .title span, #rt-body-surround.body-accentoverlay-dark .box5 .title span {color:#c6e09f;}
#rt-body-surround .box4 .title, #rt-body-surround .box1 .title {text-shadow: -1px 1px 0 #A3CD65, -3px 3px 0 rgba(0,0,0,0.15);}
#rt-body-surround .box1 a, #rt-body-surround .box1 a, #rt-body-surround .box1 .title span, #rt-body-surround #rt-top .box4 a, #rt-body-surround #rt-header .box4 a, #rt-body-surround .box4 .title span {color:#c6e09f;}
#rt-headerblock h1 span, #rt-headerblock .module-title .title span, body #rt-menu ul.menu li a {color:#A3CD65;}
#rt-headerblock .readon span, #rt-headerblock .readon .button, #rt-headerblock .button, #rt-headerblock .btn  {background-color:#8cc13f;}
#rt-headerblock,#rt-headerblock .sprocket-features-arrows .prev, #rt-headerblock .sprocket-features-arrows .next, .layout-showcase .sprocket-features-pagination li {background-color:#f0f0f0;}
#rt-headerblock .title, #rt-headerblock .paneltitle, #rt-headerblock .panelsubtitle, #rt-headerblock .sprocket-features-title {text-shadow: -1px 1px 0 #f0f0f0, -3px 3px 0 rgba(0,0,0,0.2);}
#rt-headerblock .box1 .module-surround, #rt-headerblock .box4 .module-surround {background-color:#A3CD65;}
#rt-headerblock #rt-top a, #rt-headerblock #rt-header a {color:#A3CD65;}
.headerpanel-overlay-light#rt-headerblock #rt-top a:hover, .headerpanel-overlay-light#rt-headerblock #rt-header a:hover {color:#8cc13f;}
.headerpanel-overlay-dark#rt-headerblock #rt-top a:hover, .headerpanel-overlay-dark#rt-headerblock #rt-header a:hover {color:#bada8c;}
#rt-headerblock #rt-top .box1 a, #rt-headerblock #rt-header .box1 a, #rt-headerblock .box1 .title span, #rt-headerblock #rt-top .box4 a, #rt-headerblock #rt-header .box4 a, #rt-headerblock .box4 .title span {color:#c6e09f;}
#rt-headerblock .box4 .title, #rt-headerblock .box1 .title {text-shadow: -1px 1px 0 #A3CD65, -3px 3px 0 rgba(0,0,0,0.15);}
#rt-feature h1 span, #rt-feature .module-title .title span {color:#A3CD65;}
#rt-feature .readon span, #rt-feature .readon .button, #rt-feature .button, #rt-feature .btn {background-color:#8cc13f;}
#rt-feature {background-color:#B0B8AD;}
#rt-feature .box1 .module-surround, #rt-feature .box4 .module-surround {background-color:#A3CD65;}
#rt-feature a {color:#A3CD65;}
#rt-feature .title, #rt-feature .paneltitle, #rt-feature .panelsubtitle {text-shadow: -1px 1px 0 #96a092, -3px 3px 0 rgba(0,0,0,0.2);}
#rt-feature .feature-accentoverlay-dark .box1 a, #rt-feature feature-accentoverlay-dark .box1 .title span, #rt-feature .feature-accentoverlay-dark .box4 a, #rt-feature .feature-accentoverlay-dark .box4 .title span {color:#c6e09f;}
#rt-feature .box1 .title, #rt-feature .box4 .title {text-shadow: -1px 1px 0 #A3CD65, -3px 3px 0 rgba(0,0,0,0.2);}
#rt-feature .box1 a, #rt-feature .box4 a, #rt-feature .box1 .title span, #rt-feature #rt-top .box4 a, #rt-feature #rt-header .box4 a, #rt-feature .box4 .title span {color:#c6e09f;}
#rt-showcase h1 span, #rt-showcase .module-title .title span, #rt-bottom h1 span, #rt-bottom .module-title .title span {color:#A3CD65;}
#rt-showcase .readon span, #rt-showcase .readon .button, #rt-showcase .button, #rt-showcase .btn, #rt-bottom .readon span, #rt-bottom .readon .button, #rt-bottom .button, #rt-bottom .btn {background-color:#8cc13f;}
#rt-showcase, #rt-bottom {background-color:#333;}
#rt-showcase .box1 .module-surround, #rt-showcase .box4 .module-surround, #rt-bottom .box1 .module-surround, #rt-bottom .box4 .module-surround, #rt-bottom .bottom-accentoverlay-dark .box1 a, #rt-bottom .bottom-accentoverlay-dark .box4 .title span, #rt-bottom .bottom-accentoverlay-dark .box4 a, #rt-bottom .bottom-accentoverlay-dark .box1 .title span {background-color:#A3CD65;}
#rt-showcase .title, #rt-bottom .title, #rt-showcase .paneltitle, #rt-showcase .panelsubtitle, #rt-bottom .paneltitle, #rt-bottom .panelsubtitle {text-shadow: -1px 1px 0 #333, -3px 3px 0 rgba(0,0,0,0.2);}
#rt-showcase a, #rt-bottom a {color:#A3CD65;}
#rt-showcase.showcasepanel-overlay-light a:hover, #rt-bottom.showcasepanel-overlay-light a:hover {color:#8cc13f;}
#rt-showcase.showcasepanel-overlay-dark a:hover, #rt-bottom.showcasepanel-overlay-dark a:hover {color:#bada8c;}
#rt-showcase .box1 a, #rt-showcase .box1 .title span, #rt-showcase .box4 a, #rt-showcase .box4 .title span, #rt-bottom .box1 a, #rt-bottom .box1 .title span, #rt-bottom .box4 a, #rt-bottom .box4 .title span {color:#c6e09f;}
#rt-showcase .box4 .title, #rt-showcase .box1 .title, #rt-bottom .box4 .title, #rt-bottom .box1 .title {text-shadow: -1px 1px 0 #A3CD65, -3px 3px 0 rgba(0,0,0,0.15);}
#rt-footer-surround h1 span, #rt-footer-surround .module-title .title span {color:#A3CD65;}
#rt-footer-surround .readon span, #rt-footer-surround .readon .button, #rt-footer-surround .button, #rt-footer-surround .btn {background-color:#8cc13f;}
#rt-footer-surround {background-color:#8BB757;}
#rt-footer-surround .box1 .module-surround, #rt-footer-surround .box4 .module-surround {background-color:#A3CD65;}
#rt-footer-surround.footerpanel-overlay-light .module-title .title span {color:#98c752;}
#rt-footer-surround.footerpanel-overlay-dark .module-title .title span {color:#d1e6b2;}
#rt-footer-surround a {color:#ddecc5;}
#rt-footer-surround.footerpanel-overlay-dark a:hover {color:#c6e09f;}
#rt-footer-surround.footerpanel-overlay-light a:hover {color:#7ead38;}
#rt-footer-surround .title, #rt-footer-surround .paneltitle, #rt-footer-surround .panelsubtitle {text-shadow: -1px 1px 0 #8BB757, -3px 3px 0 rgba(0,0,0,0.15);}
#rt-footer-surround .box1 a, #rt-footer-surround .box1 .title span, #rt-footer-surround .box4 a, #rt-footer-surround .box4 .title span {color:#c6e09f;}
#rt-footer-surround .box4 .title, #rt-footer-surround .box1 .title {text-shadow: -1px 1px 0 #A3CD65, -3px 3px 0 rgba(0,0,0,0.15);}
#rt-logo {background: url(/images/Yiezi-web.png) 50% 0 no-repeat !important;}
#rt-logo {width: 114px;height: 114px;}
</style>
<script src="/media/system/js/mootools-core.js" type="text/javascript"></script>
<script src="/media/system/js/core.js" type="text/javascript"></script>
<script src="/media/system/js/caption.js" type="text/javascript"></script>
<script src="/media/system/js/mootools-more.js" type="text/javascript"></script>
<script src="/libraries/gantry/js/gantry-buildspans.js" type="text/javascript"></script>
<script src="/libraries/gantry/js/gantry-inputs.js" type="text/javascript"></script>
<script src="/libraries/gantry/js/browser-engines.js" type="text/javascript"></script>
<script type="text/javascript">
window.addEvent('load', function() {
	new JCaption('img.caption');
});
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-39988305-1']);
_gaq.push(['_trackPageview']);

(function() {
	var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
	ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
	var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
	
window.addEvent('domready', function() {
	var modules = ['rt-block'];
	var header = ['h3','h2','h1'];
	GantryBuildSpans(modules, header);
});
		
InputsExclusion.push('.content_vote','#rt-popup','#rt-popuplogin','#vmMainPage','#community-wrap');
window.addEvent('domready', function(){
	document.getElements('[data-rt-menu-mobile]').addEvent('change', function(){
		window.location.href = this.value;
	});
});
</script>
</head>
<body  class="presets-preset1 logostyle-style3 textshadow-0 font-family-geneva font-size-is-large logo-type-custom menu-type-splitmenu layout-mode-responsive inputstyling-enabled-1 typography-style-light col12 option-com-content menu-yiezi ">
<div id="rt-page-surround">
	<div id="rt-headerblock" class="headerpanel-overlay-light"><div id="rt-headerblock2" class="headerpanel-pattern-textile"><div id="rt-headerblock3" class="headerpanel-accentoverlay-dark">
		<div id="rt-top-surround" >
			<div id="rt-drawer">
				<div class="rt-container">
					<div class="clear"></div>
				</div>
			</div>
		</div>
		<div id="rt-navigation" class="menu-overlay-dark"><div id="rt-navigation2"><div id="rt-navigation3" class="centered">
			<div class="rt-container">
				<div class="rt-grid-2 rt-alpha">
					<div class="rt-block logo-block">
						<a href="/" id="rt-logo"></a>
					</div>
				</div>
				<div class="rt-grid-10 rt-omega">
					<div class="rt-block menu-block">
						<div class="rt-splitmenu">
							<div class="rt-menubar">
								<ul class="menutop level1"  style="margin-left: 50px;">
									<li class="item101" >
										<span class="rt-arrow-pointer"></span>
										<a class="orphan item" href="/intro.html"  >
											<span><span>About Yiezi</span></span>
										</a>
									</li>
									<li class="item102" >
										<span class="rt-arrow-pointer"></span>
										<a class="orphan item" href="/index.php/documents"  >
											<span><span>Documents</span></span>
										</a>
									</li>
									<li class="item103 active" id="current">
										<span class="rt-arrow-pointer"></span>
										<a class="orphan item active-to-top" href="/index.php/yiezi"  >
											<span><span>Yiezi</span></span>
										</a>
									</li>
									<li class="item104" >
										<span class="rt-arrow-pointer"></span>
										<a class="orphan item" href="/index.php/updates"  >
											<span><span>Updates</span></span>
										</a>
									</li>
									<li class="item106" >
										<span class="rt-arrow-pointer"></span>
										<a class="orphan item" href="/index.php/bug-report"  >
											<span><span>Bug Report</span></span>
										</a>
									</li>
									<li class="item105" >
										<span class="rt-arrow-pointer"></span>
										<a class="orphan item" href="/index.php/announce"  >
											<span><span>Announce</span></span>
										</a>
									</li>
								</ul>
							</div><div class="clear"></div>
						</div><div class="clear"></div>
					</div>
					<div class="rt-menu-mobile">
						<select data-rt-menu-mobile>
							<option value="/"> About Yiezi</option>
							<option value="/index.php/documents"> Documents</option>
							<option value="/index.php/yiezi" selected="selected"> Yiezi</option>
							<option value="/index.php/updates"> Updates</option>
							<option value="/index.php/bug-report"> Bug Report</option>
							<option value="/index.php/announce"> Announce</option>
						</select>
					</div>
				</div>
				<div class="clear"></div>
			</div>
		</div></div></div>
	</div></div></div>
	<div id="rt-transition">
		<div id="rt-main-container" class="body-overlay-light">
			<div id="rt-body-surround" class="body-accentoverlay-dark">
				<div class="rt-container">
					<div id="rt-main" class="mb12">
						<div class="rt-container">
							<div class="rt-grid-12">
								<div id="rt-main-column">
									<div class="rt-block component-block">
										<div id="rt-mainbody">
											<div class="component-content rt-joomla">
												<div class="rt-article">
													<div class="item-page">
														<div class="article-header">
															<div class="clear"></div>
														</div>
<style type="text/css">
#fb_hello{
	position: absolute;
	top: 0%;
	left: 50%;
}

.user_icon {
	position: relative;
	width:98%;
	bottom:0%;
	background: #E4E4E4;
	overflow-x:hidden;
	overflow-y:hidden;
}

.chat_grp
{
	margin:3px;
	font-size:8pt;
	color: #555555;
}

.user_labels {
     color: red;
     background-color: white;
     font-family: "Lucida Grande", "Arial", sans-serif;
     font-size: 10px;
     font-weight: bold;
     text-align: center;
     width: 100px;
     border: 2px solid black;
     white-space: nowrap;
}

.post_labels {
     color: white;
     background-color: gray;
     font-family: "Lucida Grande", "Arial", sans-serif;
     font-size: 10px;
     font-weight: bold;
     text-align: center;
     width: 80px;
     border: 2px solid black;
     white-space: nowrap;
}  

#srch_results{
	z-index: 5; 
	position: absolute;
	top:28px;
	width:100%;
	height:0px;
	background: #000000;
	overflow:visiable;
}

.srch_icon{	
	position:float;
	height:auto;
	width:100%;
	background:#E4E4E4;
	overflow:visiable;
	word-wrap:break-word;
}

.chat_ann  
{        
	margin:3px;
	font-size:8pt;
}

#chat_input {
	position: absolute;
	bottom: 1%;
	width:74%;
	right: 1%;
}

#chat_type{
	position: absolute;
	bottom: 1%;
	width:23%;
	left: 1%;
}

#chat_log{
	position: absolute;
	top: 2%;
	height: 85%;
	width: 98%;
	background: #CCCCCC;
	right: 1%;
	overflow:auto;
}

#chat_box {
	position: absolute;
	top: 60.5%;
	right:0%;
	width:35.2%;
	bottom: -1%;
	background: #88AAAA;
}

#map_canvas {
	position: absolute;
	top: 8%;
	right:0%;
	/*left: 830px;*/
	width:35.2%;
	bottom: 40%;
	background: #DDDDDD;
}

#pano_canvas {
	position: absolute;
	top: 8%;
	/*right: 550px;*/
	width:50%; 
	/*left: 130px;*/
	left:14.7%;
	height:93%;
	background: #CCCCCC;
}

.group_talk {
	position: relative;
	width:98%;
	bottom:0%;
	background: #DDAAAA;
	overflow-x:hidden;
	overflow-y:hidden;
}

.user_goto {
	position: relative;
	width:98%;
	bottom:0%;
	left:100%;
	background:#E4E4E4;
	overflow-x:hidden;
	overflow-y:hidden;
}

#online_users{
	position: absolute;
	top:40%;
	left:0%;
	width:100%;
	bottom:0%;
	background: #DDDDDD;
	overflow-x:visiable;
	overflow-y:auto;
	/*overflow:auto;*/
}

#online{
	position: absolute;
	top:29px;
	width:50%;
        left:1%;
	height:28px;
	line-height:28px;
	text-align: center;
	background: #DDA3A3;
	overflow:visiable;
}

#offline{
	position: absolute;
	top:29px;
	width:50%;
	right:1%;
	height:28px;
	line-height:28px;
	text-align: center;
        /*A3CD65*/
	background: #A3CD65;
	overflow:visiable;
}

#showpov{
   	position: absolute;
	top:60px;
	width:98%;
	right:1%;
	height:28px;
	line-height:28px;
	text-align: center;
        /*A3CD65*/
	background: #A3CD65;
	overflow:visiable;
}

#showpov:hover{
   	position: absolute;
	top:60px;
	width:98%;
	right:1%;
	height:28px;
	line-height:28px;
	text-align: center;
        /*A3CD65*/
	background: #A0CA60;
	overflow:visiable;
}

#sharepov{
   	position: absolute;
	top:90px;
	width:98%;
	right:1%;
	height:28px;
	line-height:28px;
	text-align: center;
        /*A3CD65*/
	background: #A3CD65;
	overflow:visiable;
}

#sharepov:hover{
   	position: absolute;
	top:90px;
	width:98%;
	right:1%;
	height:28px;
	line-height:28px;
	text-align: center;
        /*A3CD65*/
	background: #A0CA60;
	overflow:visiable;
}

#defollow{
   	position: absolute;
	top:120px;
	width:98%;
	right:1%;
	height:28px;
	line-height:28px;
	text-align: center;
        /*A3CD65*/
	background: #A3CD65;
	overflow:visiable;
}

#defollow:hover{
   	position: absolute;
	top:120px;
	width:98%;
	right:1%;
	height:28px;
	line-height:28px;
	text-align: center;
        /*A3CD65*/
	background: #A0CA60;
	overflow:visiable;
}

#srch_txt{
	position: absolute;
	top: 1px;
	left:1%;
	width:95%;
	height:20px;
	overflow:visiable;
	/*overflow-y:visiable;*/
}

#side_bar{
	position: absolute;
        top: 8%;
	width:14.5%;
        height:93%;
        background-color:#999999;	
	overflow:auto;
}
#options{
	position: absolute;
	top:0px;
	left:0px;
	width:100%;
	bottom:60%;
	background: #CCCCCC;
	overflow-x:visiable;
	overflow-y:auto;
}
#loc_search{
	position: absolute;
	top:1%;	
	height:28px;
	width:100%;
	bottom:39%;
	background: #AAAACC;
	overflow-x:visiable;
	overflow-y:auto;
	/*overflow:auto;*/
}

</style>

<div id="fb_hello" class="title">Hello</div>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript" src="https://maps.google.com/maps/api/js?sensor=true&v=3.15"></script>
<!--script type="text/javascript" src="http://www.yiezi.com/include/markerclusterer.js"></script-->
<script type="text/javascript" src="http://yiezi.parseapp.com/markerclusterer.js"></script>
<!--script type="text/javascript" src="http://www.yiezi.com/include/infobubble.js"></script-->
<script type="text/javascript" src="http://yiezi.parseapp.com/infobubble.js"></script>
<!--script type="text/javascript" src="http://www.yiezi.com/include/markerwithlabel.js"></script-->
<script type="text/javascript" src="http://yiezi.parseapp.com/markerwithlabel.js"></script>
<script src="//www.parsecdn.com/js/parse-1.6.7.min.js"></script>
<!--cript type="text/javascript" src="http://connect.facebook.net/en_US/all.js"></script-->
<script type="text/javascript">
/*
interface control
*/

 /*
  * add message to chat message box系統訊息
  */
  function add_chat_status(str){
	var chat_status = document.getElementById("chat_log");
	chat_status.innerHTML += '<div class="chat_ann">' + "&nbsp;" +str+"</div>";
	scroll_Chatlog();
  }
  
  /*
  * set chat box scrollable
  */
  function scroll_Chatlog(){
	var chat_log = document.getElementById( "chat_log" );
	chat_log.scrollTop = chat_log.scrollHeight ;
  }

 /*
  * set talk_type when chat selector changed
  */
  function t_type(talk_select){ 
	talk_type = talk_select.value;
	switch(talk_type){
		case 'LPM':
			var chat_input = document.getElementById("chat_input");
			chat_input.value = '';
			hide_grp_div();
			/*set_online();*/
			break;
		case 'SPM':
			var chat_input = document.getElementById("chat_input");
			chat_input.value = '>' + talk_name + ':';
			hide_grp_div();//隱藏好友小勾勾
			/*set_online();*/
			break;
		case 'GPM':
			var chat_input = document.getElementById("chat_input");
			show_grp_div();//好友小勾勾
			chat_input.value = '';
			/*set_online();*/
			break;
		case 'MPM':
			var chat_input = document.getElementById("chat_input");
			chat_input.value = '';
			hide_grp_div();
			/*set_offline();*/
			break;	
		default:
			break;
	}
  }
 /*
  *	display all group talk div
  */
  function show_grp_div(){
	var online_users = document.getElementById('online_users');
	var sub_onlines = online_users.childNodes;
	var i = 0;
	var sub_len = sub_onlines.length;
	for( i = 0; i < sub_len; i++){
	  if(sub_onlines[i].className == "group_talk"){
		sub_onlines[i].style.display = "block";
	  }
	}
  }
 /*
  *	hide all group talk div
  */
  function hide_grp_div(){
	var online_users = document.getElementById('online_users');
	var sub_onlines = online_users.childNodes;
	var i = 0;
	var sub_len = sub_onlines.length;
	for( i = 0; i < sub_len; i++){
	  if(sub_onlines[i].className == "group_talk"){
		sub_onlines[i].style.display = "none";
	  }
	}
  }
  function REDRAW(){
	for(var i = 0; i < markers.length; i++){
	  markers[i].pre_rta = markers[i].pre_rta-1;
	}
  }
/*
 * set online mode
*/
  function set_online(){
	if(online==false){
		online = true;
		var online_div = document.getElementById("online");	
		var offline_div = document.getElementById("offline");	
		online_div.style.backgroundColor = "#A3CD65";
		offline_div.style.backgroundColor = "#DDA3A3";
		REDRAW();
		try{
		  pkm_update();
		}catch(er){
		  add_chat_status(er.toString());
		}
		last_pid = 0;
		//那個小包裹,原則3小時,last post id,記錄在這個區域內,上次新增的小包裹到第幾個,下次新增就從last_pid之後開始
		//reset last post id
		
		for(var i=0;i <= post_count ; i++){
			//clear post markers
			if(post_marker[i]){
				post_marker[i].setMap(null);
				post_marker[i]['infowindow'].close();
			}
			if(post_pano[i]){
				post_pano[i].setMap(null);
				post_pano[i]['infowindow'].close();
			}
		}
		post_count = 0;
		//reset post count
	}
	
	var chat_type = document.getElementById("chat_type");
	for(var j = 0; j< chat_type.length; j++){
		if(chat_type.options[j].value == 'MPM' 
			&& chat_type.options[j].selected == true){
			for(var i = 0; i< chat_type.length; i++){
				if(chat_type.options[i].value == 'LPM'){
				chat_type.options[i].selected = true;
				talk_type = 'LPM';
				hide_grp_div();
				//onchang chat_type when MPM
				break;
				}
			}
		}
	}
  }
 /*
  * set offline mode
  */
  function set_offline(){
	if(online == true){
		online = false;
		var online_div = document.getElementById("online");	
		var offline_div = document.getElementById("offline");	
		online_div.style.backgroundColor = "#DDA3A3";	
		offline_div.style.backgroundColor = "#A3CD65";	
		pkm_update();
	}else if(online == false){
		read_post();
	}
	var chat_type = document.getElementById("chat_type");
	for(var i = 0; i< chat_type.length; i++){
		if(chat_type.options[i].value == 'MPM'){
			chat_type.options[i].selected = true;
			talk_type = 'MPM';
			hide_grp_div();
			//onchang chat_type to MPM
			break;
		}
	}
  }

  /*
  * read offline post
  */
function read_post(){//讀post
  if(online == false){
		
	var north = map.getBounds().getNorthEast().lat();//拿boundary裡的post就好
	var south = map.getBounds().getSouthWest().lat();
	var west = map.getBounds().getSouthWest().lng();
	var east = map.getBounds().getNorthEast().lng();
	var top = 0;
	var bottom = 0;
	var postTime = new Date(Date.now() - 10800000);//3hr
	var mpm = coor_to_grid(slf_lat, slf_lng, slf_alt);
	var MPM = Parse.Object.extend(mpm);
	var queryPost;
	if(west > east){//換日線
	  var gTWest = new Parse.Query(mpm); 
	  gTWest.greaterThan("lng", west);
	  var lTEast = new Parse.Query(mpm);
	  lTEast.lessThan("lng", east);
	  queryPost = Parse.Query.or(gTWest, lTEast); 
	}else{
	  queryPost = new Parse.Query(mpm);
	  queryPost.greaterThan("lng", west);
	  queryPost.lessThan("lng", east);
	}
	queryPost.greaterThan("updatedAt", postTime);
	queryPost.greaterThan("lat", south);
	queryPost.lessThan("lat", north);
	queryPost.greaterThan("pid", last_pid);
	queryPost.startsWith("son", "post_");
	queryPost.find().then(function(results){
	  for(var i = 0; i < results.length; i++){
		var pid = results[i].get("pid");
		var uid = results[i].get("uid");
		var son = results[i].get("son");
		var lat = results[i].get("lat");
		var lng = results[i].get("lng");
		var alt = results[i].get("alt");
		var comment = results[i].get("msg");
		var tst = results[i].updatedAt;
		var post_exist = false;//新的post是不是在地圖上
		if(son == "post_Facebook"){
		  son = "Facebook";
		}
		for(var j = 0; j < post_count; j++){
			var content_check = post_marker[j]['infowindow'].getContent();
			if (content_check.indexOf(">"+pid+"<br") !=-1){//??
				post_exist = true;
				break;
			}
		}
		if(post_exist == false){
			add_post_marker(pid, uid, son, lat, lng, alt, comment, tst);
			last_pid = pid;//這個地圖上最後一個pid,boundary裡的
		}else{
			
		}
	  }
	}, function(err){
	  console.log("read Post err");
	  console.log(err);
	});
  }
}
   
function add_post_marker(pid, uid, son, lat, lng, alt, comment, tst){
	if(online == true){
		return;
	}

	if(son == "Facebook"){
		var name;
		var qstr = "SELECT name FROM user WHERE uid=" + uid;

		FB.api({
			method: 'fql.query',
			query: qstr
		}, function(response) {			
			name = response[0].name;
			var post_position = new google.maps.LatLng(lat, lng);
			var post_content = '<div style="height:auto;line-height:20px; font-size:12px">' + pid  + '<br>'
				+ '<img style="width:20px; height:20px;" src="http://graph.facebook.com/' 
				+ uid + '/picture">' + "</img>" + name + ":" +"<br>"+ comment +"<br>" 
				+ '<div style="line-height:18px; font-size:8px"><u>' +tst + "</u></div>"
				+ "</div>";
			var reply = "";//"<div>reply</div>";

			for(var i = 0; i < post_count; i++){
				//0.00007
				if((Math.abs(post_marker[i].getPosition().lat()-lat)<0.00007)
				  && (Math.abs(post_marker[i].getPosition().lng()-lng)<0.00007)){
					if(post_pano[i]['infowindow'].getContent().indexOf(post_content) == -1){//找不到post_content
						var new_content = post_pano[i]['infowindow'].getContent()
					    + post_content + reply;						
						post_marker[i]['infowindow'].setContent(new_content);
						post_pano[i]['infowindow'].setContent(new_content);						
						return;//跳到哪裡??
					}else{
						return;
					}
				}
			}	
			
			post_marker[post_count] = new MarkerWithLabel({
				position: post_position,
				map: map,										
				labelContent: pid.toString(),
				labelAnchor: new google.maps.Point(40, 0),
				draggable: true,
				icon:"http://graph.facebook.com/" + uid + "/picture?width=28&height=28",
				labelClass: "post_labels", // the CSS class for the label
				labelInBackground: false
			});

			post_pano[post_count] = new MarkerWithLabel({
				position: post_position,
				map: panorama,										
				labelContent: pid.toString(),
				labelAnchor: new google.maps.Point(40, 0),
				draggable: true,
				icon:"http://graph.facebook.com/" + uid + "/picture?width=28&height=28",
				labelClass: "post_labels", // the CSS class for the label
				labelInBackground: false
			});

			post_pano[post_count]['infowindow'] = new google.maps.InfoWindow({
				content: post_content + reply
			});
			
			post_marker[post_count]['infowindow'] = new google.maps.InfoWindow({
				content: post_content
			});
			
			google.maps.event.addListener(post_marker[post_count], "click", function (e) {
				this['infowindow'].open(map, this);
			});

			google.maps.event.addListener(post_pano[post_count], "click", function (e) {				
				this['infowindow'].open(panorama, this);
			});
			post_count++;
		});
	}
}
 /*
  * 1st time click the search text
  */
function srchFocus(){
	var srch_txt = document.getElementById("srch_txt");	
	if(srch_txt.value.toString() == "search your location!"){
	   srch_txt.value = "";
	}
}
  /*
   * 2015/09/04關閉in_keyup,功能重複
   */
function in_keyup(event){
	//this function is for ie8 only只有IE8用
	//dont know why it so sucks
	var keyCode;
    /*if (event && event.which) {
        charcode = event.which;
        alert("Case 1. event.which is " + charcode);
    }else if (event && !event.which) {
        charcode = event.keyCode;
        alert("Case 2. event.keyCode is " + charcode);
    }*/
	if (event && !event.which) {
        keyCode = event.keyCode;        
	}
	console.log("in keyup");
	var chat_input = document.getElementById("chat_input");
	if(keyCode==13&&event.shiftKey){

    }else if(keyCode==13&&chat_focus&&(chat_input.value!="")){
		event.returnValue = false;
		switch(talk_type){
			case 'LPM':
				document.jsap.LPM(talk_type, chat_input.value.toString());
				chat_input.value = '';
				break;
			case 'SPM':
				var talk_prefix = '>' + talk_name + ":";
				var msg;
				if(chat_input.value.toString().indexOf(talk_prefix)==0){
					msg = chat_input.value.toString().substring(talk_prefix.length);
				}else{
					msg = chat_input.value.toString();
				}										
				document.jsap.SPM(talk_type, talk_uid, talk_son, msg);
				var chat_log = document.getElementById("chat_log");
				chat_input.value = '';
				chat_input.value += talk_prefix;
				break;
			case 'GPM':
				var name_list = '';
				var users_box = document.getElementById("online_users");
				var ub_children = users_box.childNodes;
				for(var i=0; i < ub_children.length;i++ ){
					if(ub_children[i].className == "group_talk"){
						var gt_children = ub_children[i].childNodes;
						for(var j = 0; j < gt_children.length; j++){
							if(gt_children[j].checked){
								name_list += (gt_children[j].value + ",");
							}
						}
					}						
				}
				document.jsap.GPM(name_list, chat_input.value.toString());					
				chat_input.value = '';
				break;
			case 'MPM':
				var http_request;
				if (window.XMLHttpRequest) { // for chrome, mozilla, safari,...
					http_request = new XMLHttpRequest();
				} else if (window.ActiveXObject) { // for ie
					try {
						//for ie9
						//http_request = new ActiveXObject("Msxml2.XMLHTTP");
					}catch (e) {
						try {
							//for ie8
							http_request = new ActiveXObject("Microsoft.XMLHTTP");
						}catch (e) {
						}
					}
				}

				var url = "http://www.yiezi.com/fb_post.php";
				var params = "lat="+ slf_lat + "&lng=" + slf_lng +
					"&alt=" + slf_alt + "&comment=" + chat_input.value.toString();//+ escape(chat_input.value.toString())  ;
				http_request.open("POST", url, true);

					//Send the proper header information along with the request
				http_request.setRequestHeader("Content-type","application/x-www-form-urlencoded;charset=utf-8");
				http_request.onreadystatechange = function() {//Call a function when the state changes.
					if (http_request.readyState == 4) {							
						if (http_request.status == 200) {
							//post may okay if there is no mysql error
							add_chat_status(http_request.responseText.toString());
						}else{
							
						}
					}else{
						
					} 
				}
					
				http_request.send(params);
				chat_input.value = '';
				read_post();

				break;
			default:
				break;
		}
		//send to server
	}else if(!chat_focus){

	}else{
			
	}
}
</script>
<div id="fb-root"></div>
<script type="text/javascript">
Parse.initialize("SD0mE2dV8ZUi8pN7T8UTZpAiKymtYs7xOuApLOLN", "Dgx63wRvozw9bceaESr1GNpTbI831PjPkAcoFV9P");
var currentUser = Parse.User.current();
/*
  facebook related
*/
window.fbAsyncInit = function() {
  Parse.FacebookUtils.init({
  appId      : '157031961127939', // App ID
  version    : 'v2.0',//FB app的是2.0
  //channelUrl : 'http://yiezi.parseapp.com/channel.html', // Channel File
  //status     : true, // for integration Parse and Facebook,so we disable it
  cookie     : true, // enable cookies to allow the server to access the session
  xfbml      : true  // parse XFBML
  });
  // Additional initialization code here	

  var hi_str = document.getElementById('fb_hello');
  FB.getLoginStatus(function(response){
	if(response.status === 'connected'){
	  FB.api('/me', function(response){
		hi_str.innerHTML += ", " + response.name;
		if(currentUser == null){
		  fb_login();
		  console.log("登入啦~有餅乾吃!!");
		}else{
		  console.log("正在吃餅乾!");
		  slf_uid = response.id;
		  slf_son = "Facebook";
		  var userType = Parse.Object.extend(slf_son + "_" + slf_uid);//personal information
		  var queryType = new Parse.Query(userType);
		  queryType.equalTo("name", "user_type");
		  queryType.first().then(function(succ){
			if(succ == null){
			  if(response.gender == 'male'){
				slf_urt = "3301";
			  }else if(response.gender == 'female'){
				slf_urt = "3302";
			  }else{//預設小餅乾
				slf_urt = "3310";
			  }
			  return succ.set("value", slf_urt);
			  succ.save();
			}else{
			  slf_urt = succ.get("value");
			}
			icon_prefix = 'http://yiezi.parseapp.com/images/doll/'+ slf_urt +'-';
		  });
		  
		  //20151119 go to last position
		  
		  var userdata = Parse.Object.extend(slf_son + "_" + slf_uid);//personal information
		  //var querydata; = new Parse.Query(userdata);
		  //console.log('20151119+'+slf_son + "_" + slf_uid);
		  var query_lat = new Parse.Query(userdata).equalTo("name", "lat");
		  var query_lng = new Parse.Query(userdata).equalTo("name", "lng");
		  var query_alt = new Parse.Query(userdata).equalTo("name", "alt");
		  var query_rta = new Parse.Query(userdata).equalTo("name", "rta");
						
		  var querydata = new Parse.Query.or(query_lat,query_lng,query_alt,query_rta);
						
		  querydata.find().then(function(results){
		  //console.log('20151119');
			var old_lat;
			var old_lng;
			var old_alt;
			var old_rta;
			for(var i = 0; i < results.length; i++){
				if(results[i].get("name")=="lat"){
					old_lat = results[i].get("value");
					console.log("old_lat:"+old_lat);
				}
				if(results[i].get("name")=="lng"){
					old_lng = results[i].get("value");
				}
				if(results[i].get("name")=="alt"){
					old_alt = results[i].get("value");
				}
				if(results[i].get("name")=="rta"){
					old_rta = results[i].get("value");
				}
			}
			if(old_lat!=null && old_lng!=null && old_alt!=null && old_rta!=null && !(getUrlVar("lat")&&getUrlVar("lng"))){
				//console.log("20151119||"+old_lat+"||"+old_lng+"||"+old_rta);
				set_pov(old_lat, old_lng, old_alt, old_rta, "0");			
			}
				
							
		  });
		  //20151119
		  
		  get_friends();
		  set_online();
		  setTimeout("routine();", routineTime);
		}
	  });
	}else{
	  hi_str.innerHTML = "Hello";
	  if(currentUser !== null){
		Parse.User.logOut();//FB and Parse logout
		currentUser = Parse.User.current();
		slf_uid = "N/A";
		slf_son = "N/A";
	  }
	}
  }, {scope: 'email,user_friends,public_profile'});
};
(function(d){
  var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement('script'); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/sdk.js";
  ref.parentNode.insertBefore(js, ref);
}(document));
function fb_login(){
  Parse.FacebookUtils.logIn('email,user_friends,public_profile',{
  success: function(user) {
	var OnlineUser = Parse.Object.extend("OnlineUser");
	if (!user.existed()){		
		FB.api('/me', function(response) {
		  user.set("username", response.name);//public update open
		  //'Chat_son_uid' class
		  var incoming_message_box = "Chat_Facebook_" + response.id;//自己的parse信箱
		  var IMB = Parse.Object.extend(incoming_message_box);
		  //'son_uid' class
		  var personal_information = "Facebook_" + response.id;
		  var Person = Parse.Object.extend(personal_information);
		  if(response.gender == 'male'){
			slf_urt = "3301";
		  }else if(response.gender == 'female'){
			slf_urt = "3302";
		  }else{//預設小餅乾
			slf_urt = "3310";
		  }
		  icon_prefix = 'http://yiezi.parseapp.com/images/doll/'+ slf_urt +'-';//pano_img
		  console.log(slf_urt);
		  return user.save().then(function(results){
			
			var onlineUser = new OnlineUser();
			var imb = new IMB();
			var s_urt = new Person();
			var s_lat = new Person();
			var s_lng = new Person();
			var s_alt = new Person();
			var s_rta = new Person();
			var s_grid = new Person();
			imb.save().then(function(succ) {//寫入一筆空的資料,讀取時讀取某個時間點以後的資料
			  console.log(succ);
			  console.log("imb saved!");
			});
			onlineUser.save({
			  userObjectId: user.id,
			  username: response.name,
			  uid: response.id,
			  son: "Facebook",
			  user_type: slf_urt
			}).then(function(succ){
			  console.log(succ);
			  console.log("User signed up and logged in through Facebook!");
			  currentUser = Parse.User.current();
			  slf_uid = response.id;
			  slf_son = "Facebook";
			  get_friends();
			});
			s_urt.set("name", "user_type");
			s_urt.set("value", slf_urt);
			s_urt.save();
			s_lat.set("name", "lat");
			s_lat.set("value", slf_lat.toString());
			s_lat.save();
			s_lng.set("name", "lng");
			s_lng.set("value", slf_lng.toString());
			s_lng.save();
			s_alt.set("name", "alt");
			s_alt.set("value", slf_alt.toString());
			s_alt.save();
			s_rta.set("name", "rta");
			s_rta.set("value", slf_rta.toString());
			s_rta.save();
			s_grid.set("name", "grid");
			s_grid.set("value", coor_to_grid(slf_lat, slf_lng, slf_alt).substring(5));
			s_grid.save();			
			routine();
		  });
		  if(hi_str.innerHTML == "Hello"){
			hi_str.innerHTML += ", " + response.name; 
		  }
		});
	}else{
		console.log("User logged in through Facebook!");
		currentUser = Parse.User.current();
		var Personal = Parse.Object.extend("OnlineUser");
		var queryPersonal = new Parse.Query(Personal);
		queryPersonal.equalTo("userObjectId", currentUser.id);
		queryPersonal.first().then(function(re){
		  slf_uid = re.get("uid");
		  slf_son = re.get("son");
		  slf_urt = re.get("user_type");
		  console.log(slf_urt);
		  icon_prefix = 'http://yiezi.parseapp.com/images/doll/'+ slf_urt +'-';
		  //更新完要刪掉>>
		  
		  //<<
		  get_friends();
		  routine();
		});
	}
  }, error: function(error) {
	console.log(error);
	handleParseError(error);
	console.log("User cancelled the Facebook login or did not fully authorize.");
  }
  });
}
function handleParseError(error) {//error INVALID_SESSION_TOKEN機制
  switch (error.code) {
	case Parse.Error.INVALID_SESSION_TOKEN:
	  Parse.User.logOut();
	  //window.location.replace("http://yiezi.parseapp.com/");
	  break;
  }
}
function jump(){//reload
  window.location.replace("http://yiezi.parseapp.com/");
}
/*
 * get friend list from web page (fb user)
 * think: not fb user, how to get friends ?
 */
function get_friends() {
  var check_frdTime = new Date(Date.now() - routineTime *10);//routineTime *5時間內在線上的名單
  var OnlineUser = Parse.Object.extend("OnlineUser");
  var queryfriend = new Parse.Query(OnlineUser);
  queryfriend.equalTo("son", "Facebook");
  queryfriend.greaterThan("updatedAt", check_frdTime);
  queryfriend.notContainedIn("userObjectId", [currentUser.id]);//not myself
  queryfriend.find().then(function(re) {//online user
	if(re.length == 0){
	  return;
	}
	console.log("get_friends " + re.length);
	for(var i = 0; i < re.length; i++){
	  var frd_uid = re[i].get("uid");
	  var frd_son = re[i].get("son");
	  frd_each(frd_uid, frd_son);
	}
  }, function(error) {
	console.log("err="+error);
  });
}
/*
 * each my friend in friendlist
 */
function frd_each(uid, son){
  FB.api('/me/friends/'+ uid, function(response) {
	if (response.data[0].id == uid){
	  create_friend_div(uid, son);
	}
  });
}
/*
*  share pov on Facebook
*/
  function share_pov(){
    //cam_lat = panorama.getPosition().lat();
    //cam_lng = panorama.getPosition().lng();
    //cam_rta = panorama.getPov().heading;
	/*var pov_str = "lat=" + panorama.getPosition().lat().toString();
		pov_str	+= "&lng=" + panorama.getPosition().lng().toString();
		pov_str	+= "&rta=" + panorama.getPov().heading.toString();			
		pov_str	+= "&pitch=" + panorama.getPov().pitch.toString();
	*/
	var chat_input = document.getElementById("chat_input");	
    
	var pov_cmmt = chat_input.value; 
	var pov_str = "http://yiezi.parseapp.com/?" 
		+ "lat=" + panorama.getPosition().lat().toString() 
		+ "&lng=" + panorama.getPosition().lng().toString()
		+ "&rta=" + panorama.getPov().heading.toString()
		+ "&pitch=" + panorama.getPov().pitch.toString();
	
	chat_input.value = "";
	
	var pic_str = "http://maps.googleapis.com/maps/api/streetview?size=200x200&location="
	  + panorama.getPosition().lat().toString() + ","
	  + panorama.getPosition().lng().toString() 
	  + "&heading=" +  panorama.getPov().heading.toString()
	  + "&pitch=" + panorama.getPov().pitch.toString()
	  + "&sensor=false";
	//'http://www.yiezi.com/images/Yiezi-web.png'
	FB.getLoginStatus(function (response) {
	  if (response.status === 'connected') {  
		FB.ui({
		  method: 'feed',
		  link:pov_str,
		  caption: pov_cmmt,
		  picture: 'http://www.yiezi.com/images/Yiezi-web.png',
		}, function(response) {
		  if (response && response.post_id) {
			//success
		  }else{
			//fail
		  }				
		});
	  }else if (response.status === 'not_authorized') {  

	  }else {  

	  }
	});
	//var chat_input = document.getElementById("chat_input");	
	//chat_input.value += pov_str;
    //add_chat_status(pov_str);
  }
/*
*  show pov in chat box
*/
  function show_pov(){
	var chat_input = document.getElementById("chat_input");	
    if(chat_input.value.length>0){
	  chat_input.value = '<div onclick="set_pov('+panorama.getPosition().lat().toString()+","+panorama.getPosition().lng().toString()+",0,"+panorama.getPov().heading.toString()+","+panorama.getPov().pitch.toString()+');"><a>'+chat_input.value+"</a></div>";
	}else{
	  chat_input.value = '<div onclick="set_pov('+panorama.getPosition().lat().toString()+","+panorama.getPosition().lng().toString()+",0,"+panorama.getPov().heading.toString()+","+panorama.getPov().pitch.toString()+');"><a>some where</a></div>';
	}
  }
/*
 * set pov
 */
  function set_pov(lat, lng, alt, rta, pitch){
	try{
	  var pano_latlng = new google.maps.LatLng(lat,lng);
      cam_rta = rta;
	  cam_pitch = pitch;
	  sv.getPanoramaByLocation(pano_latlng, 50, processSVData);
	}catch(err){
	  //add_chat_status("err, set_pov");
	  //add_chat_status(err);
	}
  }
/*
 * set friend's location
 */
  function set_frd_loc(lat, lng, alt){
	cam_lat = lat;	
	cam_lng = lng;												
	cam_alt = alt;

	var dist_lat = cam_lat;
	var dist_lng = cam_lng;
	var dist_alt = 0.0;	  	 	 	  

	var angle = 0.0;

	//set char's location
	try {
		var brng = (Math.PI*cam_rta)/180;				
		var dLat = cam_r *Math.cos(brng);			
		if (Math.abs(dLat) < 1e-10) dLat = 0; // dLat < 1 mm

		dist_lat = (Math.PI*cam_lat)/180 + dLat;

		var dPhi = Math.log(Math.tan(dist_lat/2+Math.PI/4)/Math.tan(((Math.PI*cam_lat)/180)/2+Math.PI/4));
		var q = (isFinite(dLat/dPhi)) ? dLat/dPhi : Math.cos((Math.PI*cam_lat)/180);  // E-W line gives dPhi=0
		var dLon = cam_r*Math.sin(brng)/q;					
		// check for some daft bugger going past the pole, normalise latitude if so
		if (Math.abs(dist_lat) > Math.PI/2) dist_lat = dist_lat > 0 ? Math.PI-dist_lat : -Math.PI-dist_lat;

		dist_lng = (((Math.PI*cam_lng)/180)+dLon+3*Math.PI)%(2*Math.PI) - Math.PI;	

		dist_lat = dist_lat*180/Math.PI;
		dist_lng = dist_lng*180/Math.PI;
	}catch(err){
		//add_chat_status("error:" + err.toString());
	}
	cam_lat = cam_lat + (cam_lat - dist_lat);
	cam_lng = cam_lng + (cam_lng - dist_lng);
	
	var pano_latlng = new google.maps.LatLng(cam_lat,cam_lng);
	sv.getPanoramaByLocation(pano_latlng, 20, processSVData);
  }
 /*
  *  when receive friend online notice, create friend's interactive box in side bar
  */  
  function create_friend_div(uid, son){
	var chat_status = document.getElementById("chat_log");
	if(son == "Facebook"){
	  var name;
	  var qstr = "SELECT name FROM user WHERE uid=" + uid;
	  FB.api({
		method: 'fql.query',//fql only in vision 2.0,query name can be in parse
		query: qstr
	  }, function(response){
		var predetect =  document.getElementById("fb_" + uid);
		if(predetect != null){//still online
		  console.log("has frd div");
		  return;
		}
		console.log("no frd div");
		name = response[0].name;
		chat_status.innerHTML += '<div class="chat_grp"> Your friend ' + '<font color="#00AAAA">' + name + '</font> is online</div>';
		scroll_Chatlog();

		var frd_IMB = Parse.Object.extend("Chat_" + son + "_" + uid);
		var frd_imb = new frd_IMB();
		frd_imb.save({son: son + "_online", uid: slf_uid}).then(function(result) {
		  console.log("create_friend_div & write imb result");
		}, function(error) {
		  console.log("create_friend_div err=");
		  console.log(error);
		});

		var online_user = document.createElement("div");
		online_user.id = "fb_" + uid;
		online_user.className = "user_icon"; 
		//online_user.innerHTML = '&nbsp' + name;
		online_user.style.left = '1px';
		online_user.style.height = '28px';
		online_user.style.fontSize = '12px';
		online_user.style.lineHeight = '28px';
		online_user.style.whiteSpace= "nowrap";
		
		online_user.onmouseover = function() {					
			online_user.style.backgroundColor = "#CCDDCC";	
			if(talk_type!='GPM'){//not group
				var user_gotoid = "fb_" + uid + "_goto";
				var user_goto = document.getElementById(user_gotoid);
				user_goto.style.display = "block";
			}
		}
		
		online_user.onclick = function() {
			talk_name = name;
			var prefix_son = online_user.id.substring(0,2);//son
			var postfix_uid = online_user.id.substring(3);//uid
			if(prefix_son == 'fb'){
				talk_son = 'Facebook';
				talk_uid = postfix_uid;
			}
			var chat_type = document.getElementById("chat_type");
			for(var i = 0; i< chat_type.length; i++){
			  //console.log(chat_type.options[i].value);
			  if(chat_type.options[i].value == 'SPM'){
				chat_type.options[i].selected = true;
				talk_type = 'SPM';
				hide_grp_div();
				//onchang chat_type to SPM
				break;
			  }
			}
			var chat_input = document.getElementById("chat_input");
			chat_input.value = '>' +talk_name + ':'
		}
		online_user.onmouseout = function(){
			online_user.style.backgroundColor = "#E4E4E4";	
			var user_gotoid = "fb_" + uid + "_goto";
			var user_goto = document.getElementById(user_gotoid);
			user_goto.style.display = "none";									
		}
		
		var users_box = document.getElementById("online_users");
		users_box.appendChild(online_user);
		//add online friend icon
		
		var pic = document.createElement("img");  
		pic.src = "http://graph.facebook.com/"+ uid + "/picture";
		pic.align= "left";
		pic.style.height = "28px";
		pic.style.width = '28px';
		
		online_user.appendChild(pic);
		online_user.innerHTML += '&nbsp' + name;
		
		var user_goto = document.createElement("div");
		user_goto.className = "user_goto"; 
		user_goto.id = "fb_" + uid + "_goto";
		user_goto.style.height = '28px';	
		user_goto.style.lineHeight = '28px';
		user_goto.style.fontSize = '12px';
		user_goto.style.left = '1px';
		user_goto.innerHTML = '&nbsp' + "go to " + name;
		user_goto.style.display = "none";

		user_goto.onclick = function(){
			QFL(online_user.id.toString());
		}
		user_goto.onmouseover = function(){
			user_goto.style.backgroundColor = "#CCDDCC";
			user_goto.style.display = "block";
		}
		user_goto.onmouseout = function(){
			user_goto.style.backgroundColor = "#E4E4E4";
			user_goto.style.display = "none";
		}
		
		users_box.appendChild(user_goto);
		
		var group_talk = document.createElement("div");
		group_talk.className = "group_talk"; 
		group_talk.id = "fb_" + uid + "_grp";
		group_talk.style.height = '28px';	
		group_talk.style.lineHeight = '28px';
		group_talk.style.fontSize = '12px';
		group_talk.style.left = '1px';
		//group_talk.innerHTML = '&nbsp' + name;
		if(talk_type == 'GPM'){
			group_talk.style.display = "block";
		}else{
			group_talk.style.display = "none";
		}

		group_talk.onclick = function(){
			//console.log('group talk ' + online_user.id );
		}
		group_talk.onmouseover = function(){
			//group_talk.style.display = "block";
		}
		group_talk.onmouseout = function(){
			//group_talk.style.display = "none";
		}
		
		var checkbox = document.createElement('input');
		checkbox.type = "checkbox";//勾勾
		checkbox.name = "grp_talk";
		checkbox.value = "fb_" + uid;
		checkbox.id = "fb_" + uid + "_grpbox";

		//var label = document.createElement('label')
		//label.For = "id";
		//label.appendChild(document.createTextNode('label');

		group_talk.appendChild(checkbox);
		group_talk.innerHTML += '&nbsp' + name;
		//group_talk.appendChild(label);

		users_box.appendChild(group_talk);
	  });
	  //var sidebar = document.getElementById("side_bar");
	}
  }
 /*
  * when receive friend offline notice, create friend's interactive box in side bar
  */  
  function delete_friend_div(uid, son){
	var chat_status = document.getElementById("chat_log");
	if(son == "Facebook"){
		var name;
		var qstr = "SELECT name FROM user WHERE uid=" + uid;
	
		FB.api({
			method: 'fql.query',
			query: qstr
		}, function(response) {
			name = response[0].name;
			chat_status.innerHTML += '<div class="chat_grp"> Your friend <font color="#AAAA00">' + name + "</font> is offline</div>";
			scroll_Chatlog();
			var online_users = document.getElementById('online_users');
			var icon_id = "fb_" + uid;
			var goto_id = "fb_" + uid + "_goto";
			var grp_id = "fb_" + uid + "_grp";
			var user_icon = document.getElementById(icon_id);
			var goto_icon = document.getElementById(goto_id);
			var grp_icon = document.getElementById(grp_id);
			online_users.removeChild(user_icon);
			online_users.removeChild(goto_icon);
			online_users.removeChild(grp_icon);
		});
	}
  }
  
  function chatFocus(){
	chat_focus = true;
  }
  
  function chatBlur(){
	chat_focus = false;
  }
</script>
<div id="fb_button" style="position: absolute; top: 1%; right: 1%;">
<fb:login-button show-faces="false" autologoutlink="true" perms="email,user_friends,public_profile" onlogin="jump()"></fb:login-button>
</div>
<script src="http://static.ak.fbcdn.net/connect/en_US/core.js"></script>
<script>
/*
 *定時呼叫
*/
var hi_str = document.getElementById('fb_hello');

var count = 0;//parse更新用
var routineTime = 5000;//毫秒
var last_time = new Date(Date.now());
var last_SPM = new Date(Date.now());

var lat_rad = 0.005;
var lng_rad = 0.005;
var alt_rad = 5.000;
//radius of speaking

function routine(){
/*
 *  20150820蘇心潔:
 *	當第一個頁面開啟並登入後,之後開的頁面會是登入狀態,當第一個頁面登出,
 *	之後開的頁面也會一起登出;
 *	若分別開兩個頁面,皆按botton登入,當各自登出時,不會影響到其他頁面;
 *	若reload頁面,登入登出狀態皆為最新
 *	todo:試著用reeload frame的方式,確認connect最新狀態
*/
  FB.getLoginStatus(function(response){
	if(response.status === 'connected'){
	  FB.api('/me', function(response){//改成parse?
		if(hi_str.innerHTML == "Hello"){
			hi_str.innerHTML += ", " + response.name; 
		}
	  });
	  
	}else{
	  hi_str.innerHTML = "Hello";
	  if(currentUser !== null){//登入後被別的分頁登出//else本來就沒有登入
		Parse.User.logOut();
		currentUser = Parse.User.current();
		alert("已登出!");
		window.location.replace("http://yiezi.parseapp.com/");
	  }
	}
  });
  if(slf_uid != "N/A" && slf_son != "N/A"){
	  count = (count+1)%10;
	  writeState(currentUser.id, slf_urt ,slf_lat, slf_lng, slf_alt, slf_zms, slf_rta, count);
	  set_boundary(map.getBounds().getNorthEast().lat(),
	  map.getBounds().getSouthWest().lat(),
	  map.getBounds().getSouthWest().lng(),
	  map.getBounds().getNorthEast().lng(),
		9000.0, -10000);
	  read_LPM();
	  check_IMB();
	  check_frd_state();
  }
  setTimeout("routine();", routineTime);
  return;
}
function writeState(id, urt, lat, lng, alt, zms, rta, count){//State寫入
	//online user
	var OnlineUser = Parse.Object.extend("OnlineUser");
	var queryOU = new Parse.Query(OnlineUser);
	queryOU.equalTo("userObjectId",id);
	//personal information
	var Person = Parse.Object.extend(slf_son + "_" + slf_uid);
	var q_lat = new Parse.Query(Person);
	var q_lng = new Parse.Query(Person);
	var q_alt = new Parse.Query(Person);
	var q_rta = new Parse.Query(Person);
	var q_grid = new Parse.Query(Person);
	q_lat.equalTo("name", "lat");
	q_lng.equalTo("name", "lng");
	q_alt.equalTo("name", "alt");
	q_rta.equalTo("name", "rta");
	q_grid.equalTo("name", "grid");
	//online user
	queryOU.first().then(function(succ){
	  return succ.save({
		user_type:urt,
		lat: lat,
		lng: lng,
		alt: alt,
		zms: zms,
		rta: rta,
		count: count
	  });
	}).then(function(result){
	  //return;
	},function(error){
	  console.log("writeState err=");
	  console.log(error);
	});
	//personal information
	q_grid.first().then(function(succ_grid){//update時好像不能用.set
	  return succ_grid.save({
		value: coor_to_grid(slf_lat, slf_lng, slf_alt).substring(5)
	  }).then(function(succ){

	  },function(err){
		console.log(err);
	  });
	});
	q_lat.first().then(function(succ_lat){
	  return succ_lat.save({
		value: lat.toString()
	  }).then(function(succ){

	  },function(err){
		console.log(err);
	  });
	});
	q_lng.first().then(function(succ_lng){
	  return succ_lng.save({
		value: lng.toString()
	  }).then(function(succ){

	  },function(err){
		console.log(err);
	  });
	});
	q_alt.first().then(function(succ_alt){
	  return succ_alt.save({
		value: alt.toString()
	  }).then(function(succ){

	  },function(err){
		console.log(err);
	  });
	});
	q_rta.first().then(function(succ_rta){
	  return succ_rta.save({
		value: rta.toString()
	  }).then(function(succ){
	  
	  },function(err){
		console.log(err);
	  });
	});
}
function set_boundary(north_bound, south_bound, west_bound, east_bound, top_bound, bottom_bound){
  var north = north_bound;
  var south = south_bound;
  var west = west_bound;
  var east = east_bound;
  var top = top_bound;
  var bottom = bottom_bound;
  //console.log("SW lng = " + west + "," + "NE lng = " + east);
  var beforeTime = new Date(Date.now() - routineTime *10);//routineTime5倍內在線上的名單
  var OnlineUser = Parse.Object.extend("OnlineUser");
  var queryUser;
  if(west > east){//換日線
	var greaterThanWest = new Parse.Query(OnlineUser); 
	greaterThanWest.greaterThan("lng", west);
	var lessThanEast = new Parse.Query(OnlineUser);
	lessThanEast.lessThan("lng", east);
	queryUser = Parse.Query.or(greaterThanWest, lessThanEast); 
  }else{
    queryUser = new Parse.Query(OnlineUser);
	queryUser.greaterThan("lng", west);
	queryUser.lessThan("lng", east);
  }
  queryUser.greaterThan("updatedAt", beforeTime);
  queryUser.greaterThan("lat", south);
  queryUser.lessThan("lat", north);
  queryUser.notContainedIn("userObjectId", [currentUser.id]);//not myself
  
  queryUser.find().then(function(re) {//online user
	console.log("routine");
	console.log(re.length);
	markers[0] = new marker_ani();//self still alive
	markers[0].ani = true;
	//re少了自己,i = j+1
	for(var j = 0; j < re.length; j++){//markers在找到新的一輪比對後會排序
		console.log(re.length);
		//一次迴圈一筆資料, j = 0不會進來
		var data_index = -1;
		var data_uid = re[j].get("uid");
		var data_son = re[j].get("son");
		//VLC ECM??
		//if data is a old marker
		for(var i =1; i < markers.length; i++){
		  //think:是否有更好比對方法??第一萬人要比對一萬次?!
		  if(markers[i].uid == data_uid && markers[i].son == data_son){
			//think:比較方式是否換成objectId>>re[j].id
			//set the match index
			data_index = i;
			//set ani flag
			markers[i].ani = true;
			//set new location
			markers[i].dist_loc(re[j].get("lat"), re[j].get("lng"), 
			re[j].get("alt"), re[j].get("rta"));

			/*//if !NPC,show transation information
			if(!data_son.equals("NPC")&&TRA_state==0)markers.elementAt(i).set_info(
				  "<div style=\"background-color:#FFBB73;\" onclick=\"Command('TRA','0','"+uid+" "+son+" "+data_uid+" "+data_son+"');\"><text>交易 </text></div>");
			else if(!data_son.equals("NPC")&&TRA_state==1){
			  markers.elementAt(i).set_info(user_info);
			}
			else markers.elementAt(i).set_info(new marker_ani().parse_info(data));*/

			if(markers[i].pre_lat != markers[i].pst_lat || markers[i].pre_lng != markers[i].pst_lng
			  ||markers[i].pre_alt != markers[i].pst_alt || markers[i].pre_rta != markers[i].pst_rta){
			  // if new location != old location , play animation from old to new
			  /*function marker_move(index, src_lat, src_lng, src_alt, src_rta, 
			  dist_lat, dist_lng, dist_alt, dist_rta, user_type)*/
			  var frame;
			  if(markers.length > 10){
				frame = 20;
			  }else{
				frame = 100 - (4 * markers.length);
			  }
			  var mkr_move = new move_worker();
			  mkr_move.move_worker(i,
				markers[i].pre_lat, markers[i].pre_lng, markers[i].pre_alt, markers[i].pre_rta,
				markers[i].pst_lat, markers[i].pst_lng, markers[i].pst_alt, markers[i].pst_rta,
				frame, markers[i].usr_type, markers[i].uid, markers[i].son, 
				markers[i].title, markers[i].info);
			  mkr_move.run();
			  /*this.move_worker = function (marker_index, src_lat, src_lng, src_alt, src_rta, 
			  dist_lat, dist_lng, dist_alt, dist_rta, frame, user_type, uid, son, title, info)*/

			  //update location
			  markers[i].pre_lat = markers[i].pst_lat;
			  markers[i].pre_lng = markers[i].pst_lng;
			  markers[i].pre_alt = markers[i].pst_alt;
			  markers[i].pre_rta = markers[i].pst_rta;
			}else{
			  //do nothing
			}
			break;
		  }
		}
		//if data is a new marker
		if(data_index == -1){
		  //add new marker_ani to vector markers
		  var mkr = new marker_ani();
		  mkr.set_uid(data_uid);
		  mkr.set_son(data_son);
		  mkr.set_til(re[j].get("username"));		  
		  
		  
		  if(data_son == "Facebook"){
			var usr_pic = '<div style="height:32px;width:32px;line-height:20px; font-size:12px">' +
						'<img style="width:32px; height:32px;" src="http://graph.facebook.com/' 
						+ data_uid + '/picture">' + "</img>" + "</div>";
			var usr_fb = '<a href=\"https://www.facebook.com/'+data_uid+'\" target=_blank>'+mkr.title+'</a>';
			
			mkr.set_info(usr_pic+usr_fb);
		  }else{
			mkr.set_info("^^");//從檔案裡讀出來,之後做,不能塞空的,會error
		  }
		  
		  //set init = dist = loc
		  mkr.init_loc(re[j].get("lat"), re[j].get("lng"), re[j].get("alt"), re[j].get("rta"));
		  mkr.dist_loc(re[j].get("lat"), re[j].get("lng"), re[j].get("alt"), re[j].get("rta"));
		  mkr.set_urt(re[j].get("user_type"));
		  mkr.ani = true;
		  //add marker to markers array
		  markers[markers.length]= mkr;
		  //add marker to map
		  add_marker(markers.length-1, 
			mkr.pst_lat, mkr.pst_lng, mkr.pst_alt, mkr.pst_rta, 
			mkr.usr_type, mkr.uid, mkr.son, false, mkr.title, mkr.info);
		}
	}
	//end of VQL
	//EVQ
	//clear empty marker
	var empty_marker = 0;//娃娃走了的數量
	for(var i = 1; i < markers.length; i++){
		if(markers[i].ani == false){//empty就擦掉
		  //marker doest not exist,remove marker in javascript
		  clear_marker(i);
		  //add empty marker counter
		  empty_marker ++;
		  console.log("empty_marker="+empty_marker);
		}else{//marker.ani == true
		  if(empty_marker > 0){
			//there is empty marker把有空位的往前推 
			//shift marker's index in javascript
			clear_marker(i);
			add_marker(i-empty_marker, 
			  markers[i].pst_lat, markers[i].pst_lng, markers[i].pst_alt, markers[i].pst_rta, 
			  markers[i].usr_type, markers[i].uid, markers[i].son, false, markers[i].title, markers[i].info);
		  }
		}
	}
	for(var i = 0; i < markers.length;){
		//at least self
		if(markers[i].ani == true){
		  markers[i].ani = false;
		  i++;
		}else{
		  //remove empty marker from markers
		  markers.splice(i, 1);
		}
	}
	empty_marker = 0;
	mk_num(markers.length);
  },function(error) {
	console.log("set_boundary err=");
	console.log(error);
  });

  //draw NPC
  //query all stages
  var slf_grid = coor_to_grid(slf_lat, slf_lng, slf_alt);
  slf_grid = slf_grid.replace("Chat_","G");
  var all_stage = Parse.Object.extend(slf_grid);
  var query_stages = new Parse.Query(all_stage);
  
  console.log("grid name:"+slf_grid);
  console.log("query all quest");
  
  query_stages.ascending("Quest");
  query_stages.find().then(function(re) {
	quest.splice(0,quest.length);
	
	for(var j=0;j<re.length;j++){
		//console.log("quest id:"+re[j].get("Quest"));
		if(quest.indexOf(re[j].get("Quest")) == -1){
			quest.push(re[j].get("Quest"));
		}
	}
	
	//now all quest in the grid file in quest
	for(var j = 0; j<quest.length; j++){
		console.log("quest "+j+ ":"+quest[j]);
		//query personal record
		var slf_stage = Parse.Object.extend(slf_son +"_"+ slf_uid);
		console.log("query self stage:"+slf_son +"_"+ slf_uid);
		var slf_grid = coor_to_grid(slf_lat, slf_lng, slf_alt);
		slf_grid = slf_grid.replace("Chat_","G");
		console.log("grid name:"+slf_grid);
		var stage_num = new Parse.Query(slf_stage);
		console.log("quest name:"+slf_grid+"_"+quest[j]);
		stage_num.equalTo("name",slf_grid+"_"+quest[j]);
		stage_num.find().then(function(qStage){
			if(qStage.length!=0){
				console.log("stage ="+qStage.get("value"));
			}else{
				console.log("no this stage info");
				//if no result, save as 1	
			}
		},function(error){
			console.log("query single quest err=");
			console.log(error);
		});
		
					
	}
	
	
	
  },function(error){
	console.log("query all quest err=");
	console.log(error);
  });
  //query all stages
  
  /*var slf_grid = coor_to_grid(slf_lat, slf_lng, slf_alt);
  var all_stage = Parse.Object.extend(slf_grid);
  var query_all = new Parse.Query(all_stage);
  
  
  var slf_stage = Parse.Object.extend(slf_son +"_"+ slf_uid);
  var queryStage = new Parse.Query(slf_stage);
  queryStage.equalTo("name", "quest_stage");
  queryStage.find().then(function(qStage){
	console.log(qStage);
	console.log(qStage.length);
	console.log(slf_grid.substring(5));
	
	var queryNPC;
	if(west > east){//換日線
	  var gTWest = new Parse.Query("G" + slf_grid.substring(5));
	  gTWest.greaterThan("lng", west);
	  var lTEast = new Parse.Query("G" + slf_grid.substring(5));
	  lTEast.lessThan("lng", east);
	  queryNPC = Parse.Query.or(gTWest, lTEast); 
	}else{
	  queryNPC = new Parse.Query("G_" + slf_grid.substring(5));
	  queryNPC.greaterThan("lng", west);
	  queryNPC.lessThan("lng", east);
	}
	queryNPC.greaterThan("lat", south);
	queryNPC.lessThan("lat", north);

	if(qStage.length == 0){
	  queryNPC.equalTo("Stage", "1");
	  
	}else(
	  for(var i = 0; i < qStage.length; i++){
		var QS = qStage[i].split('_');
		var slf_quest[] = QS[0];
		var slf_stage[] = QS[1];
		console.log(slf_quest[i]);
		console.log(slf_stage[i]);
	  }
	  queryNPC.containedIn("Quest", slf_quest);
	  queryNPC.containedIn("Stage", slf_stage);
	)
	queryNPC.find().then(function(NPC){
	  console.log(NPC);
	  
	},function(err){
	  console.log(err);
	});
  });*/
}
/*
 * read location personal message
 */
function read_LPM(){
  var LPMgrid = Parse.Object.extend(coor_to_grid(slf_lat, slf_lng, slf_alt));
  var queryLPM = new Parse.Query(LPMgrid);
  //var query_self = new Parse.Query(LPMgrid);//使用doesNotMatchKeyInQuery還是會重複出現,還沒找到bug
  //query_self.equalTo("uid", slf_uid);
  //query_self.equalTo("son", slf_son);
  //queryLPM.doesNotMatchKeyInQuery("lat", "lng", query_self);//不包括自己
  queryLPM.greaterThan("updatedAt", last_time);
  queryLPM.find().then(function(results) {
	if(results.length == 0){
	  return;//空值就跳出
	}
	console.log(results);
	for(var i = 0; i < results.length; i++){
	  var lat_str = results[i].get("lat");
	  var lng_str = results[i].get("lng");
	  var alt_str = results[i].get("alt");
	  var lat_dist = Math.abs(lat_str - slf_lat);
	  var lng_dist = Math.abs(lng_str - slf_lng);
	  var alt_dist = Math.abs(alt_str - slf_alt);
	  if(lat_dist > lat_rad && lng_dist > lng_rad && alt_dist > alt_rad){
		console.log("continue");
		continue;
	  }else{
		var lpm_uid = results[i].get("uid");
		var lpm_son = results[i].get("son");
		if(lpm_uid == slf_uid && lpm_son == slf_son){
		  console.log("continue2");
		  continue;
		}
		var lpm_msg = results[i].get("msg");
		add_lpm(lpm_uid, lpm_son, lat_str, lng_str, alt_str, lpm_msg);
		if(lpm_msg.indexOf("Shun-Ching")!=-1){
			marker_pano[0]['infowindow'].open(panorama, marker_pano[0]);			
			//20151204 open info window by incoming message successful
		}
		if(lpm_msg.indexOf("Ching-Shun")!=-1){
			marker_pano[0]['infowindow'].close(panorama, marker_pano[0]);			
			//20151204 open info window by incoming message successful
		}
	  }
	}
	last_time = results[results.length-1].updatedAt;
  }, function(error) {
	console.log("read_LPM err=");
	console.log(error);
  });
}
/*
 * send query friend's location
 */
function QFL(frd_data){
  var frd, fsn;
  if(frd_data.length > 4){
	fsn = frd_data.substring(0, 2);
	frd = frd_data.substring(3);
  }else{
	return;
  }
  if(fsn == "fb"){
	fsn = "Facebook";
  }
  var QFL = Parse.Object.extend("OnlineUser");
  var queryQFL = new Parse.Query(QFL);
  queryQFL.equalTo("son", fsn);
  queryQFL.equalTo("uid", frd);
  queryQFL.first().then(function(succ) {
	frd_lat = succ.get("lat");
	frd_lng = succ.get("lng");
	frd_alt = succ.get("alt");
	set_frd_loc(frd_lat, frd_lng, frd_alt);
  }, function(err){
	console.log("QFL error=");
	console.log(err);
  });
}
/*
 * check incoming message box (fb)
 */
function check_IMB(){
  var check_stateTime = new Date(Date.now() - routineTime *10);
  var myBox = "Chat_" + slf_son + "_" + slf_uid;
  var myIMB = Parse.Object.extend(myBox);
  var queryfrdIMB = new Parse.Query(myIMB);
  queryfrdIMB.greaterThan("updatedAt", check_stateTime);
  queryfrdIMB.equalTo("son", slf_son + "_online");//notEqualTo Facebook
  queryfrdIMB.find().then(function(succ){
	for(var i = 0; i < succ.length; i++){
	  var frd_uid = succ[i].get("uid");
	  var frd_son = slf_son;//不一定是自己的son
	  create_friend_div(frd_uid, frd_son);
	}
  });
  
  //incoming message
  var querySPM = new Parse.Query(myIMB);
  querySPM.greaterThan("updatedAt", last_SPM);
  querySPM.notEqualTo("son", slf_son + "_online");//equalTo slf_son
  querySPM.find().then(function(succ){
	if(succ.length == 0){
	  return;//空值就跳出
	}
	for(var i = 0; i < succ.length; i++){
	  var r_uid = succ[i].get("uid");
	  var r_son = succ[i].get("son");
	  var r_msg = succ[i].get("msg");
	  var grp_msg = r_son.substring(0,3);
	  if(grp_msg == "grp"){
		r_son = r_son.substring(4);
		rcv_mmsg(r_uid, r_son, r_msg);
	  }else{
		rcv_msg(r_uid, r_son, r_msg);
	  }
	}
	last_SPM = succ[succ.length-1].updatedAt;
  });
}
function check_frd_state(){
  var user_icon = document.getElementsByClassName("user_icon");
  for(i = 0; i < user_icon.length; i++){
	var myfrd_son = user_icon[i].id.substring(0,2);
	var myfrd_uid = user_icon[i].id.substring(3);
	if(myfrd_son == "fb"){
	  myfrd_son = "Facebook";
	}
	compare_frd_state(myfrd_uid, myfrd_son);
  }
}
function compare_frd_state(uid, son){
  var compare_stateTime = new Date(Date.now() - routineTime *10);
  //20151204 
  var OnlineUser = Parse.Object.extend("OnlineUser");
  var queryfrd = new Parse.Query(OnlineUser);
  queryfrd.equalTo("son", son);
  queryfrd.equalTo("uid", uid);
  queryfrd.greaterThan("updatedAt", compare_stateTime);
  queryfrd.first().then(function(succ){
	if(succ == null){//didn't find online so delete div
	  console.log("null");
	  delete_friend_div(uid, son);
	}
  },function(err){
	console.log("compare_frd_state err=");
	console.log(err);
  });
}
</script>
<div id="side_bar">
	<div id="options">
		<div id="loc_search"><center>
			<input type="text" id="srch_txt" style="width:95%;" value="search your location!" onfocus="srchFocus();" onkeyup="srchKey();">
			</center>
		</div>
		<div id="mode">
			<div id="online" onclick="set_online();">Users</div>
			<div id="offline" onclick="set_offline();">Post</div>
		</div>
		<div id="showpov" onclick="show_pov();">Get Position</div>
		<div id="sharepov" onclick="share_pov();">Share on Facebook</div>
		<div id="defollow" onclick="defollow();">defollow</div>
		<div id="srch_results"></div>
	</div>
	<div id="online_users"></div>
</div>
<div id="pano_canvas" ></div>
<div id="map_canvas"></div>
<div id="chat_box">
	<div id="chat_log">
		<div class="chat_ann">&nbsp;Starting...</div>
	</div>
	<select id="chat_type" onChange="t_type(this)">
		<option value="LPM" selected>Speak:</option>
		<option value="SPM">Talk to:</option>
		<option value="GPM">Broadcast:</option>
		<option value="MPM">post on map:</option>
	</select>
	<textarea id="chat_input" rows=1 onfocus="chatFocus();" onblur="chatBlur();"></textarea><!-- onkeyup="in_keyup(event);"-->
</div>
<script type="text/javascript">
//螢幕寬度:screen.width
//螢幕高度:screen.height
//可瀏覽頁面寬度:screen.availWidth
//可瀏覽頁面高度:screen.availHeight
//setup size of screen

 if(screen.width >= 800 && screen.height >= 600){
  var side_bar= document.getElementById("rt-main-column");
  side_bar.style.height = (screen.availHeight*0.65).toString()+'px';
  
  var side_bar2= document.getElementById("rt-mainbody");
  side_bar2.style.height = '100%';
  //alert(screen.height.toString()+'px');

  if(!document.getElementsByClassName) {
    var side_bar3 = document.querySelectorAll('.rt-article');
	//alert('rt-article:'+side_bar3.length);
	side_bar3[0].style.height = (screen.availHeight*0.65).toString()+'px';
  }else{
	var side_bar3 = document.getElementsByClassName("rt-article");
	//alert('rt-article:'+side_bar3.length);
	side_bar3[0].style.height = '100%';
  }
  
  if(!document.getElementsByClassName) {
	var side_bar3_1 = document.querySelectorAll('.rt-block component-block');
	side_bar3_1[0].style.height = (screen.availHeight*0.65).toString()+'px';
  }else{
	var side_bar3_1 = document.getElementsByClassName("rt-block component-block");
	side_bar3_1[0].style.height = '100%';
  }  
  
  if(!document.getElementsByClassName) {
	var side_bar3_3= document.querySelectorAll('.component-content rt-joomla');
	side_bar3_3[0].style.height = (screen.availHeight*0.65).toString()+'px';
  }else{
	var side_bar3_3= document.getElementsByClassName("component-content rt-joomla");
	side_bar3_3[0].style.height = '100%';  
  }

  if(!document.getElementsByClassName) {
	var side_bar3_2= document.querySelectorAll('.rt-article');
	side_bar3_2[0].style.height = (screen.availHeight*0.65).toString()+'px';
  }else{
	var side_bar3_2= document.getElementsByClassName("rt-article");
	side_bar3_2[0].style.height = '100%';
  }

  if(!document.getElementsByClassName) {
	var side_bar4= document.querySelectorAll('.item-page');
	side_bar4[0].style.height = (screen.availHeight*0.65).toString()+'px';  
  }else{
	var side_bar4= document.getElementsByClassName("item-page");
	side_bar4[0].style.height = '100%';
  }
  
  var side_bar5= document.getElementById("side_bar");
  side_bar5.style.height = '93%';
  //alert(screen.height.toString()+'px');

 }else{
  //alert("手機");
 }
</script>
<script type="text/javascript">
/*
global variables
*/
var marker = new Array();
var marker_pano = new Array();
var post_marker = new Array();
var post_pano = new Array();
var infobubble = new Array();
var ibLabel = new Array();
var mk_rta = new Array();
var mk_urt = new Array();
var quest = new Array();
var marker_count = 0;
var post_count = 0;

var markers = new Array();//其他人
var markers_count = 0;

var map;
var map_img = "http://maps.gstatic.com/mapfiles/cb/man_arrow-";
var panorama;
var sv = new google.maps.StreetViewService();
var lst_keypress = 0;
var geocoder = new google.maps.Geocoder();
var slf_marker_pano;//for offline presentation

var markerCluster;
var panoCluster;

var post_sem = false; //for post semaphore
/* 
default map elements
*/

var isFirefox;
var isIE;
//browser type		

var chat_focus = true;
var head_focus = false;

var talk_type = 'LPM';
var talk_gname = '';
var talk_uid = '';
var talk_son = '';
var talk_name = '';
//talk variables

var slf_lat;
var slf_lng;
var slf_alt;
var slf_rta;
var slf_zms;
var slf_tst;
var loc_per;
var urt_per;
var slf_urt;
var slf_uid;
var slf_son;
//3310 for default pegman
//3301 for default male
//3302 for defailt female

var cmt_per;
//self location information

var icon_prefix = "http://maps.gstatic.com/mapfiles/cb/man_arrow-";//後面加角度

var tmp_lat;
var tmp_lng;
var tmp_alt;
//temp location information

var lst_lat;
var lst_lng;
var lst_alt;
var lst_rta;
var lst_zms;
var lst_tst;
var lst_loc_per;
var lst_urt_per;
var lst_urt;
var lst_per;
//last updated information

var frd_lat;
var frd_lng;
var frd_alt;
var frd_update = false;
//result of query friend's location

var third_view = false; //flag for 1st or 3rd person view mode, not work now
var online = false;		//online (multi-users) flag, when false shows posts
var last_pid = 0;		//last post id
var post_id = 0;
var cam_r = 0.00000085;	//radius from camara
//set_self(lat, lng, alt, zms, tst, rta, loc_per, urt_per, urt, cmt_per);
/* 
default user element
*/
var cam_lat;
var cam_lng;
var cam_alt;
var cam_rta=0.0;
var cam_pitch;
//panorama location data


var self_index = 0;
var max_marker = 512;
/* maximun markers on the map */

/*marker animation存起點和終點*/
/*class marker_ani*/

function marker_ani(){
	this.ani = false;//不能用var
	this.max_ani = 5;
	this.index;//宣告
	this.ani_count;//走路的動畫

	this.pre_lat;
	this.pre_lng;
	this.pre_alt;
	this.pre_rta;//前一個狀態

	this.pst_lat;
	this.pst_lng;
	this.pst_alt;
	this.pst_rta;//新的狀態

	this.title;
	this.uid;
	this.son;
	this.usr_type;
	this.info;

	this.set_uid = function (str){
		this.uid = str;//this指的是自身,後面的.uid是變數
	};
	this.set_til = function (str){			
		this.title = str;
	};
	this.set_info = function (info){
		this.info = info;
	};
	this.set_son = function (str){			
		this.son = str;
	};
	this.set_urt = function (str){
		this.usr_type = str;
	};
}
marker_ani.prototype.init_loc = function (lat, lng, alt, rta){
		this.pre_lat = lat;//定義
		this.pre_lng = lng;
		this.pre_alt = alt;
		this.pre_rta = rta;
		this.ani_count = this.max_ani;
	};
marker_ani.prototype.dist_loc = function (lat, lng, alt, rta){
		this.pst_lat = lat;
		this.pst_lng = lng;
		this.pst_alt = alt;
		this.pst_rta = rta;
	};
	
/*class marker_ani*/

/*動畫,拆成frame,用worker*/
/*class marker_move*/
function move_worker(){
	this.src_lat;
	this.src_lng;
	this.src_alt;

	this.dist_lat;
	this.dist_lng;
	this.dist_alt;

	this.src_rta;
	this.dist_rta;
	this.marker_index;
	this.frame;

	this.title;
	this.uid;
	this.son;
	this.usr_type;
	this.info;
	this.move_worker = function (marker_index, src_lat, src_lng, src_alt, src_rta, 
	dist_lat, dist_lng, dist_alt, dist_rta, frame, user_type, uid, son, title, info){
		
		this.marker_index = marker_index;
		this.src_lat = src_lat;
		this.src_lng = src_lng;
		this.src_alt = src_alt;
		this.src_rta = src_rta;
		this.dist_lat = dist_lat;
		this.dist_lng = dist_lng;
		this.dist_alt = dist_alt;
		this.dist_rta = dist_rta;
		this.frame = frame;
		this.user_type = user_type;
		this.uid = uid;
		this.son = son;
		this.title = title;
		this.info = info;
	}
}
move_worker.prototype.run = function (){
	//synchronized (markers.elementAt(this.marker_index)){//??
		if(window.Worker){//Worker相容性
			var myWorker = new Worker("http://yiezi.parseapp.com/worker.js");
			myWorker.postMessage([this.marker_index, this.frame, 
			this.src_lat, this.src_lng, this.src_alt, this.src_rta, 
			this.dist_lat, this.dist_lng, this.dist_alt, this.dist_rta, 
			this.user_type, this.uid, this.son, this.title, this.info]);

			/*console.log(this.marker_index+","+ this.dist_lat+","+ this.dist_lng+","+ 
			this.dist_alt+","+ this.dist_rta+","+ this.user_type+","+ this.uid+","+ 
			this.son+","+this.self+","+ this.title+","+ this.info);*/
			
			myWorker.onmessage = function(e) {
				/*postMessage([frame, index, src_lat+ frame* delta_lat, src_lng+ frame* delta_lng, 
				src_alt+ frame* delta_alt, src_rta, dist_lat, dist_lng, dist_alt, 
				dist_rta, user_type, true]);*/
				var j = e.data[0];
				this.marker_index = e.data[1];
				this.src_lat = e.data[2];
				this.src_lng = e.data[3];
				this.src_alt = e.data[4];
				this.src_rta = e.data[5];
				this.dist_lat = e.data[6];
				this.dist_lng = e.data[7];
				this.dist_alt = e.data[8];
				this.dist_rta = e.data[9];
				this.user_type = e.data[10];
				this.uid = e.data[11];
				this.son = e.data[12];
				this.title = e.data[13];
				this.info = e.data[14];
				var lastMove = e.data[15];
				
				//marker_move(ani_count, index, src_lat, src_lng, src_alt, src_rta, dist_lat, dist_lng, dist_alt, dist_rta, urt)
				marker_move(j, this.marker_index, this.src_lat, this.src_lng, this.src_alt, this.src_rta, 
					this.dist_lat, this.dist_lng, this.dist_alt, this.dist_rta, this.user_type);
				
				if(lastMove == true){
					clear_marker(this.marker_index);
					this.self;
					if(this.marker_index == 0){
						this.self = true;
					}else{
						this.self = false;
					}
					add_marker(this.marker_index, this.dist_lat, this.dist_lng, 
					this.dist_alt, this.dist_rta, this.user_type, this.uid, 
					this.son, this.self, this.title, this.info);
					myWorker.terminate();//結束myWorker
				}
			};
			
		}else{
			console.log("no worker!");
		}
	};
/*class marker_move*/
</script>
<script type="text/javascript">
/*
chat message box
*/

/*
* add chat message around the location into chat message box
*/
function add_lpm(uid, son, lat, lng, alt, msg){
  var chat_status = document.getElementById("chat_log");
  if(son == "Facebook"){
	var name;
	var qstr = "SELECT name FROM user WHERE uid=" + uid;
	FB.api({
	  method: 'fql.query',
	  query: qstr
	}, function(response) {
	  name = response[0].name;
	  chat_status.innerHTML += '<div class="chat_grp"><font color="#00AA00">'+ name + " :</font>" + msg +"</div>";
	  scroll_Chatlog();
	});
  }
}
 /*
  *  display the sended message from person to person自己打的送到框框
  */
  function sended_msg(s_uid, s_son, s_msg){
	var chat_status = document.getElementById("chat_log");
	if(s_son=="Facebook"){
	  var name;
	  var qstr = "SELECT name FROM user WHERE uid=" + s_uid;
	  FB.api({
		method: 'fql.query',
		query: qstr
	  }, function(response) {
		name = response[0].name;
		chat_status.innerHTML += '<div class="chat_grp"><font color="#009999">' + "To:" + name + " :</font>" + s_msg +"</div>";
		scroll_Chatlog();
	  });
	}
  }
 /*
  * receieved message from s_uid@s_son別人打進來的
  */
  function rcv_msg(s_uid, s_son, s_msg){
	var chat_status = document.getElementById("chat_log");
	if(s_son=="Facebook"){
	  var name;
	  var qstr = "SELECT name FROM user WHERE uid=" + s_uid;
	  FB.api({
		method: 'fql.query',
		query: qstr
	  },function(response) {
		name = response[0].name;
		chat_status.innerHTML += '<div class="chat_grp"><font color="#00BBBB">' + "From:" + name + " :</font>" + s_msg +"</div>";
		scroll_Chatlog();
	  });
	}
  }
/*
   * display the sended multi-users' message from person to persons
  */
  function sended_mmsg(s_uid, s_son, user_list, s_msg){
	var chat_status = document.getElementById("chat_log");
	var name_list = '';
	console.log(s_uid+","+s_son+","+user_list+","+s_msg);
	var son_uid = user_list.split(",");
	for(var i = 0; i < son_uid.length-1 ; i++){//??
	  //name_list += (name_query(son_uid[i])+",");
	}

	if(s_son=="Facebook"){
	  var name;
	  var qstr = "SELECT name FROM user WHERE uid=" + s_uid;

	  FB.api({
		method: 'fql.query',
		query: qstr
	  }, function(response) {
		name = response[0].name;
		chat_status.innerHTML += '<div class="chat_grp"><font color="#00AAAA">' + name + " :</font>" + s_msg +"</div>";
		scroll_Chatlog();
	  });
	}
  }
 /*
  * receieved multi-users message from s_uid@s_son
  */
  function rcv_mmsg(s_uid, s_son, s_msg){
	var chat_status = document.getElementById("chat_log");
	console.log(s_uid+","+s_son+","+s_msg);
	if(s_son=="Facebook"){
	  var name;
	  var qstr = "SELECT name FROM user WHERE uid=" + s_uid;
	  FB.api({
		method: 'fql.query',
		query: qstr
	  }, function(response) {			
		name = response[0].name;
		chat_status.innerHTML += '<div class="chat_grp"><font color="#00AAAA">' + "From:" + name + " :</font>" + s_msg +"</div>";
		scroll_Chatlog();
	  });
	}
  }
/*
 * divide the map into grid
 */
function coor_to_grid(lat, lng, alt){
  var lat_str = Math.ceil(lat);
  var lng_str = Math.floor(lng);
  if(lat_str > 0){
	lat_str = lat_str.toString() + "N";
  }else{
	lat_str = Math.abs(lat_str);
	lat_str = lat_str.toString() + "S";
  }
  if(lng_str > 0){
	lng_str = lng_str.toString() + "E";
  }else{
	lng_str = Math.abs(lng_str);
	lng_str = lng_str.toString() + "W";
  }
  return "Chat_" + lat_str + lng_str;
}
</script>
<script type="text/javascript">
window.onload = initial();
/*
google map api v3 scripit
*/

 /*
  *  initial function
  */ 
  function initial(){
	
    //cam_lat = 25.033477;
	cam_lat = 25.032979;
	//cam_lng = 121.56559300000004;
	cam_lng = 121.56505300000003;
	cam_alt = 0.0;
	//cam_rta = -81.17867057247197;
	cam_rta = 64.9088838048889;
	//cam_pitch = 0;
	cam_pitch = 51.46165891953079;
		
	var cam_latlng = new google.maps.LatLng(cam_lat,cam_lng);
	//set camara location information

	lst_lat = 0.0;
	lst_lng = 0.0;
	lst_alt = 0.0;
	lst_rta = 0.0;
	//set last updated location

	frd_lat = 0.0;
	frd_lng = 0.0;
	frd_alt = 0.0;
	//set initial friend's location(query result)
	
	slf_zms = 18;
	slf_alt = 0.0;
	slf_rta = cam_rta;	
	
	
	var panoramaOptions = {
                position: cam_latlng,
                pov: {
			      heading: cam_rta,
			      pitch: cam_pitch,
			      zoom: 1
	            }				
			  };
	panorama = new  google.maps.StreetViewPanorama(document.getElementById("pano_canvas"), panoramaOptions);
		
	var myOptions = {
					zoom: slf_zms,
					center: cam_latlng,
					mapTypeId: google.maps.MapTypeId.ROADMAP,
					streetViewControl: false
				};
	map = new google.maps.Map(document.getElementById("map_canvas"),myOptions);	
	
	slf_tst = "Sat, 01 Nov 2008 19:35:00 GMT";
	loc_per = "ALL";
	urt_per = "ALL";
	cmt_per = "ALL";
	slf_urt = "3310";
	//may set by ui, not implemented
	
	google.maps.event.addListener(panorama, 'position_changed', function() {
		last_pid = 0;//歸零
		read_post();
		cam_lat = panorama.getPosition().lat();
		cam_lng = panorama.getPosition().lng();
		cam_rta = panorama.getPov().heading;

		var dist_lat = cam_lat;//計算用,指目標位置
		var dist_lng = cam_lng;
		var dist_alt = 0.0;
		//set char's location自己的角色位置
		try{
			var brng = (Math.PI*cam_rta)/180;				
			var dLat = cam_r *Math.cos(brng);

			if (Math.abs(dLat) < 1e-10) dLat = 0; // dLat < 1 mm
			
			dist_lat = (Math.PI*cam_lat)/180 + dLat;			
			
			var dPhi =Math.log(Math.tan(dist_lat/2+Math.PI/4)/Math.tan(((Math.PI*cam_lat)/180)/2+Math.PI/4));
			var q = (isFinite(dLat/dPhi)) ? dLat/dPhi : Math.cos((Math.PI*cam_lat)/180);  // E-W line gives dPhi=0
			var dLon = cam_r*Math.sin(brng)/q;					
			// check for some daft bugger going past the pole, normalise latitude if so
			if (Math.abs(dist_lat) > Math.PI/2) dist_lat = dist_lat > 0 ? Math.PI-dist_lat : -Math.PI-dist_lat;

			dist_lng = (((Math.PI*cam_lng)/180)+dLon+3*Math.PI)%(2*Math.PI) - Math.PI;
			
			dist_lat = dist_lat*180/Math.PI;
			dist_lng = dist_lng*180/Math.PI;
		}catch(err){
			//add_chat_status("error:" + err.toString());
		}
			
		var angle=0.0;
		var angle2=0.0;
	
		try{
			//計算娃娃移動後的經緯度,透過鏡頭的經緯度、鏡頭與娃娃距離、轉向的角度計算
			if(dist_lat!=slf_lat||dist_lng!=slf_lng){
				angle = Math.atan2( 
					Math.sin( ( dist_lng - cam_lng ) * Math.PI / 180 ) * Math.cos( dist_lat * Math.PI / 180 ), 
					Math.cos( cam_lat * Math.PI / 180) * Math.sin( dist_lat * Math.PI / 180 ) - Math.sin( cam_lat * Math.PI / 180 ) * Math.cos( dist_lat * Math.PI / 180 ) * Math.cos( ( dist_lng - cam_lng ) * Math.PI / 180 ) );	
				angle = ( angle * 180 / Math.PI + 360 ) % 360;

				angle2 = Math.atan2( 
					Math.sin( ( dist_lng - slf_lng ) * Math.PI / 180 ) * Math.cos( dist_lat * Math.PI / 180 ), 
					Math.cos( slf_lat * Math.PI / 180 ) * Math.sin( dist_lat * Math.PI / 180 ) - Math.sin( slf_lat * Math.PI / 180 ) * Math.cos( dist_lat * Math.PI / 180 ) * Math.cos( ( dist_lng - slf_lng ) * Math.PI / 180 ) );			
				angle2 = ( angle2 * 180 / Math.PI + 360 ) % 360;
				//第一人稱臉永遠背對鏡頭;第三人稱若左轉,臉方向跟著移動方向改變,鏡頭可看到左半側臉
				if(third_view){//true表示第三人稱計算方式,若向左轉45度>>娃娃往鏡頭左邊移動45度
					slf_rta = angle2; //娃娃的角度
					angle = angle2 - angle;							  
				}else{								
					slf_rta = panorama.getPov().heading;	
					angle = 0.0;
				}
				
				while(angle > 360){
					angle = angle - 360;	
				}
				while (angle < 0) {
					angle = angle + 360;
				}		
			}
		}catch(err){
			//add_chat_status("error:" + err.toString());
		}	
		slf_lat = dist_lat;
		slf_lng = dist_lng;		
		
		console.log("position="+slf_lat);
		console.log("position="+slf_lng);
		
		var map_latlng = new google.maps.LatLng(slf_lat,slf_lng);
		map.setCenter(map_latlng);

		if(marker_pano[0]){
			var mov_latlng = new google.maps.LatLng(slf_lat, slf_lng);						
			try{
				marker_pano[0].setPosition(mov_latlng);	//fail when move south		
				marker[0].setPosition(mov_latlng);  
				//set icon
				var pano_img = 'http://yiezi.parseapp.com/images/doll/'+ slf_urt +'-';
					
				var pano_ars = (Math.round(angle/22.5))%16;	
				pano_img = pano_img + pano_ars.toString() + ".png";
				try{
					marker_pano[0].setIcon(pano_img);
				}catch(err){
					//add_chat_status("error1:" + err.toString());	
				}
				
				while (slf_rta < 0) {
					slf_rta = slf_rta + 360;
				}
				while(slf_rta > 360){
					slf_rta = slf_rta - 360;	
				}
		
				var img = 'http://yiezi.parseapp.com/images/dolls/'+ slf_urt +'-';
				console.log("3");
				
				var ars = (Math.round(slf_rta/22.5))%16;//360度切成16張圖,落在第幾個區間,'%'保證不會超過16(0~15)
				img = img + ars.toString() + ".png";//ars圖的編號
				try{
					marker[0].setIcon(img);
				}catch(err){
					//add_chat_status("error1:" + err.toString());	
				}
			}catch(err){
				//add_chat_status("error1:" + err.toString());	
				//map.setZoom(map.getZoom()+1);
				//map.setZoom(map.getZoom()-1);
			}		  
		}else{
			FB.getLoginStatus(function(response) {
				if (response.status === 'connected') {					
					FB.api('/me', function(response) {//娃娃誕生
						//clear_marker(0);
						//新增一個有名字的娃娃,info指令,index = 0>>自己,fsn>>social network(son),self(判斷是不是自己)
						var self_pic = '<div style="height:32px;width:32px;line-height:20px; font-size:12px">' +
						'<img style="width:32px; height:32px;" src="http://graph.facebook.com/' 
						+ response.id + '/picture">' + "</img>" + "</div>";
						console.log(slf_uid);
						console.log("add_marker 0");
						add_marker(0 , slf_lat, slf_lng, slf_alt, slf_rta, slf_urt, response.id, "Facebook", true, response.name, self_pic);
						//add_marker(index , lat, lng, alt, rta, urt, uid, fsn, self, title, info)
					});
				}else if(response.status === 'not_authorized') {
			
				}else{
				
				}
			});
		}
		var chat_input = document.getElementById("chat_input");
		chat_input.blur();
		pkm_update();
	});
	
	google.maps.event.addListener(panorama, 'pov_changed', function() {
		console.log("pov_changed");
		last_pid = 0;
	  
		cam_lat = panorama.getPosition().lat();
		cam_lng = panorama.getPosition().lng();
		cam_rta = panorama.getPov().heading;
	  	
		var dist_lat = cam_lat;
		var dist_lng = cam_lng;
		var dist_alt = 0.0;
		var angle = 0.0;
	  
		//set char's location
		try{
			var brng = (Math.PI*cam_rta)/180;				
			var dLat = cam_r *Math.cos(brng);			
			if (Math.abs(dLat) < 1e-10) dLat = 0; // dLat < 1 mm
			
			dist_lat = (Math.PI*cam_lat)/180 + dLat;
			
			var dPhi = Math.log(Math.tan(dist_lat/2+Math.PI/4)/Math.tan(((Math.PI*cam_lat)/180)/2+Math.PI/4));
			var q = (isFinite(dLat/dPhi)) ? dLat/dPhi : Math.cos((Math.PI*cam_lat)/180);  // E-W line gives dPhi=0
			var dLon = cam_r*Math.sin(brng)/q;					
			// check for some daft bugger going past the pole, normalise latitude if so
			if (Math.abs(dist_lat) > Math.PI/2) dist_lat = dist_lat > 0 ? Math.PI-dist_lat : -Math.PI-dist_lat;

			dist_lng = (((Math.PI*cam_lng)/180)+dLon+3*Math.PI)%(2*Math.PI) - Math.PI;	
			
			dist_lat = dist_lat*180/Math.PI;
			dist_lng = dist_lng*180/Math.PI;
		}catch(err){
			//add_chat_status("error:" + err.toString());
		}

		try{
			if(dist_lat!=slf_lat||dist_lng!=slf_lng){
				angle = Math.atan2( 
					Math.sin( ( dist_lng - cam_lng ) * Math.PI / 180 ) * Math.cos( dist_lat * Math.PI / 180 ), 
					Math.cos( cam_lat * Math.PI / 180) * Math.sin( dist_lat * Math.PI / 180 ) - Math.sin( cam_lat * Math.PI / 180 ) * Math.cos( dist_lat * Math.PI / 180 ) * Math.cos( ( dist_lng - cam_lng ) * Math.PI / 180 ) );	
				angle = ( angle * 180 / Math.PI + 360 ) % 360;

				angle2 = Math.atan2( 
					Math.sin( ( dist_lng - slf_lng ) * Math.PI / 180 ) * Math.cos( dist_lat * Math.PI / 180 ), 
					Math.cos( slf_lat * Math.PI / 180 ) * Math.sin( dist_lat * Math.PI / 180 ) - Math.sin( slf_lat * Math.PI / 180 ) * Math.cos( dist_lat * Math.PI / 180 ) * Math.cos( ( dist_lng - slf_lng ) * Math.PI / 180 ) );			
				angle2 = ( angle2 * 180 / Math.PI + 360 ) % 360;

				if(third_view){
					slf_rta = angle2; 
					angle = angle2 - angle;							  
				}else{								
					slf_rta = panorama.getPov().heading;	
					angle = 0.0;
				}

				while(angle > 360){
					angle = angle - 360;	
				}
				while (angle < 0) {
					angle = angle + 360;
				}
			}
		}catch(err){
			add_chat_status("err:" + err.toString());
		}		
	
		slf_lat = dist_lat;
		//2014/07/14
		//add_chat_status("lat:" + slf_lat.toString());
		//2014/07/14
		slf_lng = dist_lng;
		//2014/07/14
		//add_chat_status("lng:" + slf_lng.toString());
		//2014/07/14
		
		var map_latlng = new google.maps.LatLng(slf_lat,slf_lng);
		map.setCenter(map_latlng);
		//update_slf(0);

		if(marker_pano[0]){
			var mov_latlng = new google.maps.LatLng(slf_lat, slf_lng);						
			try{
				marker_pano[0].setPosition(mov_latlng);	//fail when move south		
				marker[0].setPosition(mov_latlng);  
			
				//set icon
				var pano_img = 'http://yiezi.parseapp.com/images/doll/'+ slf_urt +'-';
				
				var pano_ars = (Math.round(angle/22.5))%16;	
				pano_img = pano_img + pano_ars.toString() + ".png"; 
		
				marker_pano[0].setIcon(pano_img);
		
				while (slf_rta < 0) {
					slf_rta = slf_rta + 360;
				}
				while(slf_rta > 360){
					slf_rta = slf_rta - 360;	
				}
		
				var img = 'http://yiezi.parseapp.com/images/dolls/'+ slf_urt +'-'; 
				console.log("4");
				var ars = (Math.round(slf_rta/22.5))%16;
				img = img + ars.toString() + ".png";
		
				marker[0].setIcon(img);
			}catch(err){
				//add_chat_status("error2:" + err.toString());
				//map.setZoom(map.getZoom()+1);
				//map.setZoom(map.getZoom()-1);		
			}		  
		}else{	  
			FB.getLoginStatus(function(response) {
				if (response.status === 'connected') {					
					FB.api('/me', function(response) {
						var self_pic = '<div style="height:32px;width:32px;line-height:20px; font-size:12px">' +
						'<img style="width:32px; height:32px;" src="http://graph.facebook.com/' 
						+ response.id + '/picture">' + "</img>" + "</div>";
						console.log(slf_uid);
						console.log("add_marker 0");
						add_marker(0 , slf_lat, slf_lng, slf_alt, slf_rta, slf_urt, response.id, "Facebook", true, response.name, self_pic);
						//add_marker(index , lat, lng, alt, rta, urt, uid, fsn, self, title, info)
					});
				}else if(response.status === 'not_authorized'){
				
				}else{
				
				}
			});
		}
		var chat_input = document.getElementById("chat_input");
		chat_input.blur();
		pkm_update();
	});
	
	google.maps.event.addListener(map, 'click', function(event) {
		last_pid = 0;
		read_post();
		sv.getPanoramaByLocation(event.latLng, 500, processSVData);//經緯,周圍500M有街景的東西,callback

		var chat_input = document.getElementById("chat_input");
		chat_input.blur();
	});
	
	google.maps.event.addListener(map, 'dragend', function() {
		last_pid = 0;
		read_post();
		var map_latlng = new google.maps.LatLng(slf_lat,slf_lng);
		map.setCenter(map_latlng);	//拉地圖時會彈回來,因為center會綁在marker上		
	});
	
	google.maps.event.addListener(map, 'zoom_changed', function(event) {  					
		if(marker_pano[0]){
			map.setCenter(marker_pano[0].getPosition());
		}
		last_pid = 0;
		read_post();
	});
	
	document.onkeypress = function(event){
	  var keyCode = event.which;// ? event.which : event.keyCode;
	  var chat_input = document.getElementById("chat_input");
	  if(keyCode == 13 && event.shiftKey){

	  }else if(keyCode == 13 && chat_focus){//寫入
		event.preventDefault();//擋不住第一個空白行
		if(!chat_input.value){
		  return;
		}
		console.log("document.onkeypress = "+chat_input.value.length+","+chat_input.value.toString());
		var OnlineUser = Parse.Object.extend("OnlineUser");
		var queryOu = new Parse.Query(OnlineUser);
		queryOu.equalTo("userObjectId",currentUser.id);
		queryOu.first().then(function(succ) {
			console.log(succ);
			console.log("succ  "+slf_uid+" "+slf_son);
			slf_uid = succ.get("uid");
			slf_son = succ.get("son");
			switch(talk_type){
				case 'LPM'://Chat_25N121E
					var ALCgrid = Parse.Object.extend(coor_to_grid(slf_lat, slf_lng, slf_alt));
					var alcgrid = new ALCgrid();
					var msg = chat_input.value.toString();
					alcgrid.save({
					  son: slf_son,
					  uid: slf_uid,
					  msg: msg,
					  lat: slf_lat,
					  lng: slf_lng,
					  alt: slf_alt
					}).then(function(result) {
					  console.log("LPM write " + msg);
					  add_lpm(slf_uid, slf_son, slf_lat, slf_lng, slf_alt, msg);
					}, function(error) {
					  console.log("LPM err=");
					  console.log(error);
					});
					chat_input.value = '';
					break;
				case 'SPM'://Chat_Facebook_123456789
					var talk_prefix = '>' + talk_name + ":";
					var msg;
					if(chat_input.value.toString().indexOf(talk_prefix) == 0){//talk_prefix = null
					  msg = chat_input.value.toString().substring(talk_prefix.length);
					}else{
					  msg = chat_input.value.toString();
					}
					console.log("SPM msg  "+msg);
					
					var SPM = "Chat_" + talk_son + "_" + talk_uid;
					var writeSPM = Parse.Object.extend(SPM);
					var writespm = new writeSPM();
					writespm.save({
					  son: slf_son,
					  uid: slf_uid,
					  msg: msg
					}).then(function(result) {
					  sended_msg(talk_uid, talk_son, msg);
					  //show sended message
					  chat_input.value = '';
					  chat_input.value += talk_prefix;
					  console.log("SPM write");
					}, function(error) {
					  console.log("SPM err=");
					  console.log(error);
					});
					break;
				case 'GPM':
					var name_list = '';
					var users_box = document.getElementById("online_users");
					var ub_children = users_box.childNodes;
					for(var i=0; i < ub_children.length; i++){
						if(ub_children[i].className == "group_talk"){
						  var gt_children = ub_children[i].childNodes;//直接抓group_talk?
						  var msg = chat_input.value.toString();
						  for(var j = 0; j < gt_children.length; j++){
							if(gt_children[j].checked){//checkbox打勾
							  name_list += (gt_children[j].value + ",");
							  var gpm_son = gt_children[j].value.substring(0,2);
							  if(gpm_son == "fb"){
								gpm_son = "Facebook";
							  }
							  var gpm_uid = gt_children[j].value.substring(3);
							  var GPM = "Chat_" + gpm_son + "_" + gpm_uid;
							  var writeGPM = Parse.Object.extend(GPM);
							  var writegpm = new writeGPM();
							  writegpm.save({
								son: "grp_"+slf_son,
								uid: slf_uid,
								msg: msg
							  }).then(function(result) {
								console.log("GPM write" +msg);
							  }, function(error) {
								console.log("GPM err=");
								console.log(error);
							  });
							}
						  }
						}						
					}
					sended_mmsg(slf_uid, slf_son, name_list, msg);
					chat_input.value = '';
					break;
				case 'MPM'://post
					var msg = chat_input.value.toString();
					var writeMPM = Parse.Object.extend(coor_to_grid(slf_lat, slf_lng, slf_alt));
					var queryMPM = new Parse.Query(writeMPM);
					var writempm = new writeMPM();
					console.log(post_id);
					queryMPM.startsWith("son", "post_");
					queryMPM.descending("updatedAt");
					queryMPM.first().then(function(succ){
					  console.log(succ);
					  if(succ == null){
						console.log(post_id);
					  }else{
						post_id = succ.get("pid") + 1;
						console.log(post_id);
					  }
					  return writempm.save({
						son: "post_"+slf_son,
						uid: slf_uid,
						msg: msg,
						lat: slf_lat,
						lng: slf_lng,
						alt: slf_alt,
						pid: post_id
					  });
					}).then(function(result){
					  add_chat_status("POST : " + msg);
					  read_post();
					  console.log("MPM write");
					}, function(err){
					  console.log("MPM err=");
					  console.log(err);
					});
					chat_input.value = '';
					break;
				default:
					break;
			}
			//send to server
		},function(err) {
			console.log("queryOu=");
			console.log(err);
		});
	  }else if(!chat_focus){
		
	  }else{
		
	  }
	};
	
	try{		
		//set_pov(lat, lng, alt, rta, pitch);
		if(getUrlVar("lat")&&getUrlVar("lng")&&getUrlVar("rta")&&getUrlVar("pitch")){
			//add_chat_status("lat="+getUrlVar("lat")+"&lng="+getUrlVar("lng")+"&rta="+getUrlVar("rta")+"&pitch="+getUrlVar("pitch"));
			set_pov(getUrlVar("lat"), getUrlVar("lng"), "0", getUrlVar("rta"), getUrlVar("pitch"));			
		}else if(getUrlVar("lat")&&getUrlVar("lng")&&getUrlVar("rta")){
			set_pov(getUrlVar("lat"), getUrlVar("lng"), "0", getUrlVar("rta"), cam_pitch);
		}else if(getUrlVar("lat")&&getUrlVar("lng")){
			set_pov(getUrlVar("lat"), getUrlVar("lng"), "0", cam_rta, cam_pitch);
		}else if(getUrlVar("geostr")){
				
		}else{
			
		}
	}catch(err){
		
		//add_chat_status(err);	
	}
	//sv.getPanoramaByLocation(cam_latlng, 500, processSVData);
	//cam_lat = data.location.latLng.lat();
	//cam_lng = data.location.latLng.lng();
  }

/*
 *  get GET variables
*/
  function getUrlVar(requestedKey) {
	var vars = [], hash;
	var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');

	for (var i = 0; i < hashes.length; i++) {
		hash = hashes[i].split('=');
		vars.push(hash[0]);
		vars[hash[0]] = hash[1];
	}
	if (typeof requestedKey == 'undefined') {
		return vars;
	} else {
		return vars[requestedKey];
	}
  }

  
/*
 * clear the marker[index]
 */
function clear_marker(index){
	console.log("clear");
	try{
		marker[index].setMap(null);
		marker_pano[index].setMap(null);
	}catch(err){
	}
}
  
  /* 
   * update markers in panorama
   * called when camara(point of view) changed
  */
  function pkm_update(){
	for(var i = 0; i < max_marker; i++){
		if(!marker[i]){
			continue;		
		}
		
		var pano_img = 'http://yiezi.parseapp.com/images/doll/'+ mk_urt[i] +'-';
		

		while(mk_rta[i] > 360){
			mk_rta[i] = mk_rta[i] -360;
		}
		while(mk_rta[i] < 0){
			mk_rta[i] = mk_rta[i] + 360;
		}
		
		var lat = marker[i].getPosition().lat();
		var lng = marker[i].getPosition().lng();

		var angle = Math.atan2( 
		Math.sin( ( lng - cam_lng ) * Math.PI / 180 ) * Math.cos( lat * Math.PI / 180 ), 
		Math.cos( cam_lat * Math.PI / 180 ) * Math.sin( lat * Math.PI / 180 ) - Math.sin( cam_lat * Math.PI / 180 ) * Math.cos( lat * Math.PI / 180 ) * Math.cos( ( lng - cam_lng ) * Math.PI / 180 ) );
	
		angle = (angle* 180 / Math.PI+360) % 360;
	
		while(angle > 360){
			angle = angle - 360;	
		}
		while (angle < 0) {
			angle = angle + 360;
		}

		angle = mk_rta[i] - angle;
	
		while(angle > 360){
			angle = angle - 360;	
		}
		while (angle < 0) {
			angle = angle + 360;
		}

		var pano_ars = (Math.round(angle/22.5))%16;	
		pano_img = pano_img + pano_ars.toString() + ".png"; 

		if(i==self_index){
			
		}else{
			marker_pano[i].setIcon(pano_img);
		}
		if((!online)&&(i!=self_index)){
			marker_pano[i].setMap(null);
			marker[i].setMap(null);	
			marker_pano[i]['infowindow'].close();
			marker[i]['infowindow'].close();
		}
	}
  };

 /*
  * move marker[index] to src facing dist with animation count number
  */
  function marker_move(ani_count, index, src_lat, src_lng, src_alt, src_rta, dist_lat, dist_lng, dist_alt, dist_rta, urt){
	if(!online){
		return;
	}
	cam_lat = panorama.getPosition().lat();
	cam_lng = panorama.getPosition().lng();	
	
	var mov_lat = src_lat;// + i * tmp_lat;
	var mov_lng = src_lng;// + i * tmp_lng;
	var angle = Math.atan2( 
	Math.sin( ( mov_lng - cam_lng ) * Math.PI / 180 ) * Math.cos( mov_lat * Math.PI / 180 ), 
	Math.cos( cam_lat * Math.PI / 180) * Math.sin( mov_lat * Math.PI / 180 ) - Math.sin( cam_lat * Math.PI / 180 ) * Math.cos( mov_lat * Math.PI / 180 ) * Math.cos( ( mov_lng - cam_lng ) * Math.PI / 180 ) );	
	angle = ( angle * 180 / Math.PI + 360 ) % 360;
	
	var angle2 = Math.atan2( 
	Math.sin( ( dist_lng - mov_lng ) * Math.PI / 180 ) * Math.cos( dist_lat * Math.PI / 180 ), 
	Math.cos( mov_lat * Math.PI / 180 ) * Math.sin( dist_lat * Math.PI / 180 ) - Math.sin( mov_lat * Math.PI / 180 ) * Math.cos( dist_lat * Math.PI / 180 ) * Math.cos( ( dist_lng - mov_lng ) * Math.PI / 180 ) );			
	angle2 = ( angle2 * 180 / Math.PI + 360 ) % 360;
	
	angle = angle2 - angle;

	while(angle > 360){
		angle = angle - 360;	
	}
	while (angle < 0) {
		angle = angle + 360;
	}		
	
	//set icon
	var pano_img = 'http://yiezi.parseapp.com/images/doll/'+ urt +'-';
	var img = 'http://yiezi.parseapp.com/images/dolls/'+ urt +'-';
	console.log("5");

	var pano_ars = (Math.round(angle/22.5))%16;	
	pano_img = pano_img + pano_ars.toString() + ".png"; 
	
	//marker_pano[index].setIcon(pano_img);

	var ars = (Math.round(angle2/22.5))%16;	
	img = img + ars.toString() + ".png";
	
	try{
		marker_pano[index].setIcon(pano_img);
		marker[index].setIcon(img);
	}catch(err){
		console.log("err1="+err);
	}
	//set position
	var mov_latlng = new google.maps.LatLng(mov_lat, mov_lng);
	
	try{
		marker_pano[index].setPosition(mov_latlng);	//fail when move south		
		marker[index].setPosition(mov_latlng);  
	}catch(err){
		console.log("err2="+err);
		//map.setZoom(map.getZoom()+1);
		//map.setZoom(map.getZoom()-1);
	}
	//console.log(mov_latlng);
  }
  
 /*
  * set the number of markers
  */
  function mk_num(number){
	marker_count = number;
  }
  /*
   * processSVData check if there is panorama data
  */
  function processSVData(data, status) {
	if (status == google.maps.StreetViewStatus.OK) {
		//add_chat_status("processsvdata");
		//add_chat_status(data.location.latLng);
		if(panorama){
		  //cam_rta = panorama.getPov().heading;
		  //add_chat_status("pano changing");
		  try{
			  panorama.setPov({
					heading: parseFloat(cam_rta),
					zoom:1,
					pitch:parseFloat(cam_pitch)}
			  );
			  panorama.setPosition(data.location.latLng);
		  }catch(err){
			//add_chat_status(err);
		  }
		  //add_chat_status("pano changed");
		}else{
			//add_chat_status("panorama is not initialized");
		}						
		
		cam_lat = data.location.latLng.lat();
		cam_lng = data.location.latLng.lng();

		try {
			var brng = (Math.PI*cam_rta)/180;
			var dLat = cam_r*Math.cos(brng);
			slf_lat = (Math.PI*cam_lat)/180 + dLat;
			var dPhi = Math.log(Math.tan(slf_lat/2+Math.PI/4)/Math.tan(((Math.PI*cam_lat)/180 )/2+Math.PI/4));
			var q = (isFinite(dLat/dPhi)) ? dLat/dPhi : Math.cos((Math.PI*cam_lat)/180);  // E-W line gives dPhi=0
			var dLon = cam_r*Math.sin(brng)/q;

			// check for some daft bugger going past the pole, normalise latitude if so
			if (Math.abs(slf_lat) > Math.PI/2) slf_lat = slf_lat>0 ? Math.PI-slf_lat : -Math.PI-slf_lat;

			slf_lng = (((Math.PI*cam_lng)/180)+dLon+Math.PI)%(2*Math.PI) - Math.PI;
			slf_lat = slf_lat*180/Math.PI;
			slf_lng = slf_lng*180/Math.PI;
		}catch(err){
			//add_chat_status("error:" + err.toString());
		}	
		
		var map_latlng = new google.maps.LatLng(slf_lat,slf_lng);
		
		if(map){
			map.setCenter(map_latlng);
		}
		
		if(!marker[0]){
			FB.getLoginStatus(function(response) {
				if (response.status === 'connected'){						
					FB.api('/me', function(response){
						var self_pic = '<div style="height:32px;width:32px;line-height:20px; font-size:12px">' +
						'<img style="width:32px; height:32px;" src="http://graph.facebook.com/' 
						+ response.id + '/picture">' + "</img>" + "</div>";
						console.log(slf_uid);
						console.log("add_marker 0");
						add_marker(0 , slf_lat, slf_lng, slf_alt, slf_rta, slf_urt, response.id, "Facebook", true, response.name, self_pic);
					});
				}else if(response.status === 'not_authorized'){
	
				}else {
				}
			});
		}
	}else{          		  	
	  /*add_chat_status('Street View data is not found in 500 meters of this location.');
	  add_chat_status('Please click another position on map or operate the streetview.');*/
	  console.log('Street View data is not found in 500 meters of this location.');
	}
  }
	
    /*
   * add marker[index] marker_pano[index] for users on map
  */
  function add_marker(index , lat, lng, alt, rta, urt, uid, fsn, self, title, info){//畫娃娃
    console.log("add");
	if(online==false && index >0 ){	
		return;
	}
	
	mk_rta[index] = rta;
	mk_urt[index] = urt;
	//male
	////slf_urt = "3301";
	//female
	////slf_urt = "3302";
	if(index == 0){//可針對自己的marker做特效
	  map_img = 'http://yiezi.parseapp.com/images/dolls/'+ slf_urt +'-';
	  pano_img = 'http://yiezi.parseapp.com/images/doll/'+ slf_urt +'-';
	  console.log("1");
	}else{
	  map_img = 'http://yiezi.parseapp.com/images/dolls/'+ urt +'-';
	  pano_img = 'http://yiezi.parseapp.com/images/doll/'+ urt +'-';
	  console.log("2");
	}
	var img = icon_prefix + '0.png';//"http://maps.gstatic.com/mapfiles/cb/man_arrow-0.png";作用???
	//var map_img = icon_prefix;//"http://maps.gstatic.com/mapfiles/cb/man_arrow-";//0.png";  
	//var pano_img = icon_prefix;//"http://maps.gstatic.com/mapfiles/cb/man_arrow-";//0.png"; 

	while(rta > 360){
		rta = rta -360;
	}
	while(rta < 0){
		rta = rta + 360;
	}
	
	var ars = (Math.round(rta/22.5))%16;
	
	map_img = map_img + ars.toString() + ".png"; 	
  
    if(marker[index]) {//擦掉娃娃
		marker[index].setMap(null);
		marker[index]['infowindow'].close();
		//marker[index]['infowindow'].setMap(null);
	}
	if(marker_pano[index]) {
		marker_pano[index].setMap(null);
		marker_pano[index]['infowindow'].close();
		//marker_pano[index]['infowindow'].setMap(null);
	}
	
	var mklatlng = new google.maps.LatLng(lat,lng);	
	
	var angle = Math.atan2( 
	Math.sin( ( lng - cam_lng ) * Math.PI / 180 ) * Math.cos( lat * Math.PI / 180 ), 
	Math.cos( cam_lat * Math.PI / 180 ) * Math.sin( lat * Math.PI / 180 ) - Math.sin( cam_lat * Math.PI / 180 ) * Math.cos( lat * Math.PI / 180 ) * Math.cos( ( lng - cam_lng ) * Math.PI / 180  ) );
	
	angle = ( angle * 180 / Math.PI + 360 ) % 360;
	
	while(angle > 360){
		angle = angle - 360;	
	}
	while (angle < 0) {
		angle = angle + 360;
	}

	var pano_label = title;
	
	angle = rta - angle;
	
	while(angle > 360){
		angle = angle - 360;
	}
	while (angle < 0) {
		angle = angle + 360;
	}

	//panorama icon
	if((!online)&&(index!=0)){
		return;
	}
	if(index!=0){
		var pano_ars = (Math.round(angle/22.5))%16;	
		pano_img = pano_img + pano_ars.toString() + ".png"; 	
	}else{
		pano_img = 'http://yiezi.parseapp.com/images/doll/'+ slf_urt +'-0.png';
		//self_index = index;
		//now use self_index = 0
	}

	marker_pano[index] = new MarkerWithLabel({
       position: mklatlng,
       map: panorama,      
	   title: title,
       labelContent: pano_label,
	   icon: pano_img,	
       labelAnchor: new google.maps.Point(50, 0),
       labelClass: "user_labels" // the CSS class for the label
       //labelStyle: {opacity: 0.50}
     });	
	 
	if(marker_pano[index]['infowindow']){
		if(info!=marker_pano[index]['infowindow'].getContent()){			
			marker_pano[index]['infowindow'].setContent(info);
		}	
	}else{
		if(info!=""){
			marker_pano[index]['infowindow'] = new google.maps.InfoWindow({
				content: info
			});	
		}
	}

	//may use different set of icons between map and panorama
	marker[index] = new MarkerWithLabel({
		position: mklatlng,
		map:map,
		title: title,
		labelContent: title,
		icon: map_img,
		labelAnchor: new google.maps.Point(50, 0),
		labelClass: "user_labels"
	});
	if(marker[index]['infowindow']){
		if(info!=marker[index]['infowindow'].getContent()){
			
			marker[index]['infowindow'].setContent(info);
		}	
	}else{
		if(info!=""){
			marker[index]['infowindow'] = new google.maps.InfoWindow({
				content: info
			});	
		}
	}
	google.maps.event.addListener(marker[index], "click", function (e) {
				this['infowindow'].open(map, this);
				});
								
	google.maps.event.addListener(marker_pano[index], "click", function (e) {				
				this['infowindow'].open(panorama, this);
				});
	
	if(index==0){
		marker[index].setDraggable(true);
		marker_pano[index].setDraggable(true);
		
		google.maps.event.addListener(marker[index], 'dragend', function (event){						
			sv.getPanoramaByLocation(event.latLng, 50, processSVData);
		});
		
		google.maps.event.addListener(marker_pano[index], 'dragend', function (event){			
			sv.getPanoramaByLocation(event.latLng, 50, processSVData);			
		});	
	}	
	console.log("add complete");
  }

 /*
  * use google.maps.Geocoder() translate search text to location
  */
  function srchKey(){
	
	var srch_txt = document.getElementById("srch_txt");	
	var input_str = srch_txt.value.toString();
	
	if(input_str.length>0){
		geocoder.geocode( { 'address': input_str}, function(results, status) {		
		   
          if (status == google.maps.GeocoderStatus.OK){
            var srch_results = document.getElementById("srch_results");	
			while (srch_results.firstChild) {
				srch_results.removeChild(srch_results.firstChild);
			}
			
			if(input_str==''){
				return;
			}
			
			for(var i = 0; i<results.length ; i++){				
				var srch_icon = document.createElement("div");
				srch_icon.className = "srch_icon"; 
				srch_icon.id = results[i].geometry.location;
				srch_icon.style.lineHeight = '28px';
				srch_icon.style.fontSize = '12px';
				srch_icon.style.left = '1px';
				srch_icon.innerHTML = results[i].formatted_address.toString();
				srch_icon.style.display = "block";

				srch_icon.onclick = function() {					
					cam_lat = parseFloat(this.id.substring(this.id.indexOf('(')+1,this.id.indexOf(',')));
					cam_lng = parseFloat(this.id.substring(this.id.indexOf(',')+2,this.id.indexOf(')')));
					
					var pano_latlng = new google.maps.LatLng(cam_lat,cam_lng);
					
					sv.getPanoramaByLocation(pano_latlng, 500, processSVData);
					
					var srch_results = document.getElementById("srch_results");	
					
					while (srch_results.firstChild) {
						srch_results.removeChild(srch_results.firstChild);
					}
					
					var srch_txt = document.getElementById("srch_txt");	
	
					srch_txt.value = "search your location!";
					
				};
				srch_icon.onmouseover = function() {
					this.style.backgroundColor = "#CCDDCC";	
					this.style.display = "block";							
				};
				
				srch_icon.onmouseout = function(){		
					this.style.backgroundColor = "#E4E4E4";
				};												
				
				srch_results.appendChild(srch_icon);

			}
          }else{
			//alert('Geocode was not successful for the following reason: ' + status);
          }
		});
	}else{
		var srch_results = document.getElementById("srch_results");	
		
		while (srch_results.firstChild) {
			srch_results.removeChild(srch_results.firstChild);
		}
	}
  }
  
  function Command(grid_file, quest_id, command_id){
    try{
		  document.jsap.PAQ(grid_file, quest_id, command_id);
		  //add_chat_status("grid file:"+grid_file);
		  //add_chat_status("quest id:"+quest_id);
		  //add_chat_status("command id:"+command_id);
	}catch(er){
	 add_chat_status(er.toString());
	}
	/*
	//send quest command
   public void PAQ(String grid_file, String quest_id, String command_id){
	   if(init_flag==false){
		   return;
	   }
	   String msg=null;
	   if(grid_file.equals("TRA")){
		   String[] trade = command_id.split(" ");
		   trade_uid=trade[2];
		   trade_son=trade[3];
		   msg="TRA "+quest_id+" "+command_id;
		   if(quest_id.equals("0"))TRA_state=1;
		   for(int i=1;i<markers.size();i++){
			   if(markers.elementAt(i).uid.equals(trade_uid)&&markers.elementAt(i).son.equals(trade_son)){
				   markers.elementAt(i).ani = true;
				   markers.elementAt(i).dist_loc(
						  markers.elementAt(i).pre_lat+0.000001,
						  markers.elementAt(i).pre_lng,
						  markers.elementAt(i).pre_alt,
						  markers.elementAt(i).pre_rta
	 					  );
				   if(markers.elementAt(i).pre_lat != markers.elementAt(i).pst_lat
	        				||markers.elementAt(i).pre_lng != markers.elementAt(i).pst_lng
	        				||markers.elementAt(i).pre_alt != markers.elementAt(i).pst_alt
	        				||markers.elementAt(i).pre_rta != markers.elementAt(i).pst_rta){
					   int frame;
					   if(markers.size()>10){
						   frame = 20;
					   }else{
						   frame = 100 - (4*markers.size());
					   }
					   marker_move mkr_move =
					    		new marker_move(i,
					    				markers.elementAt(i).pre_lat, markers.elementAt(i).pre_lng, markers.elementAt(i).pre_alt, markers.elementAt(i).pre_rta,
					    				markers.elementAt(i).pst_lat, markers.elementAt(i).pst_lng, markers.elementAt(i).pst_alt, markers.elementAt(i).pst_rta,
					    				frame,
					    				markers.elementAt(i).usr_type,
					    				markers.elementAt(i).uid,
					    				markers.elementAt(i).son,
					    				markers.elementAt(i).title,
					    				markers.elementAt(i).info
					    				);
					   mkr_move.start();
					   markers.elementAt(i).pre_lat = markers.elementAt(i).pst_lat;
		        	   markers.elementAt(i).pre_lng = markers.elementAt(i).pst_lng;
		        	   markers.elementAt(i).pre_alt = markers.elementAt(i).pst_alt;
		        	   markers.elementAt(i).pre_rta = markers.elementAt(i).pst_rta;
				   }
				   
			   }  
		   }
		    
	   }
	   else if(grid_file.equals("ITM")){
		   msg="ITM "+quest_id+" "+command_id;	
	   }
	   else{
		   msg = "PAQ " + grid_file + " " + quest_id + " " + command_id + "\n";
	   }
	   
	   Object testArray5[]; 
  	   testArray5 = new Object[1];  	  
  	   
	   
	   try{
		   	//testArray5[0]= usr + ":---:" + pm_s + " sent fail" ;
	  	    //jso.call("add_chat_status", testArray5);	
		   
		   	 //write utf-8 string to server
	    	 int t_lng = msg.getBytes("utf-8").length;      	   
	    	 while(t_lng>0){
	    		 byte b_lng = (byte)(t_lng& 0x7f);
	    		 t_lng=t_lng>>7;
	    		 if(t_lng > 0){
	    			 b_lng |= 0x80;
	    		 }
	    		 out.writeByte(b_lng);
	    	 }  
	    	 //out.writeByte((byte)(loc_msg.getBytes().length));
	    	 //out.writeUTF(new Integer(loc_msg.getBytes().length).toString());    	 
	         out.write(msg.getBytes("utf-8"));
	         out.flush();
	         //write utf-8 string to server  
		   
	         Object testArray7[]; 
	    	 testArray7 = new Object[3];
	    	  
	    	 //testArray7[0] = t_uid;
	    	 //testArray7[1] = t_son;
	    	 //testArray7[2] = pm_s + " ";
	    	 
	    	 //jso.call("sended_msg", testArray7);
	         //show sended message
	         
	   }catch(Exception except){
	    	  
	    	 testArray5[0]= "PAQ" + ":" + msg + " sent fail" ;
	    	 jso.call("add_chat_status", testArray5);		    
	   }
	   
   }
	*/
  }
</script>			
													</div>
												</div>
											</div>
										</div><div class="clear"></div>
									</div>
								</div>
							</div><div class="clear"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div id="rt-footer-surround" class="footerpanel-overlay-dark"><div id="rt-footer-surround2" class="footerpanel-pattern-leather"><div id="rt-footer-surround3" class="footerpanel-accentoverlay-dark">
		<div id="rt-copyright"><div id="rt-copyright2">
			<div style="right:0%;top:0%">
				<div style="right:50%;top:0%;">
					<span>&nbsp;&nbsp;powered by Yiezi</span>
				</div>	
			</div>
			<div class="rt-container">
				<div class="clear"></div>
			</div>
		</div></div>
	</div></div></div>
</div>
</body>
</html>
